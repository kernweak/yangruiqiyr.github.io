<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="系统调用笔记上"><meta name="keywords" content="系统调用,驱动学习"><meta name="author" content="yangruiqi,undefined"><meta name="copyright" content="yangruiqi"><title>系统调用笔记上 | manyouyou</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.5"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: {"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}"},"path":"search.xml"}
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#API函数的调用过程（3环部分）"><span class="toc-number">1.</span> <span class="toc-text">API函数的调用过程（3环部分）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-API"><span class="toc-number">1.1.</span> <span class="toc-text">Windows API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#API函数的调用过程（3环进0环-上）"><span class="toc-number">2.</span> <span class="toc-text">API函数的调用过程（3环进0环 上）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#KUSER-SHARED-DATA（Kernel和Use共享了一块数据）"><span class="toc-number">2.1.</span> <span class="toc-text">_KUSER_SHARED_DATA（Kernel和Use共享了一块数据）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x7FFE0300到底存储的是什么？"><span class="toc-number">2.2.</span> <span class="toc-text">0x7FFE0300到底存储的是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进0环需要更改哪些寄存器？"><span class="toc-number">2.3.</span> <span class="toc-text">进0环需要更改哪些寄存器？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不支持快速调用时候，中断门进0环："><span class="toc-number">2.4.</span> <span class="toc-text">不支持快速调用时候，中断门进0环：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#当CPU支持快速调用时候"><span class="toc-number">2.5.</span> <span class="toc-text">当CPU支持快速调用时候</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么叫快速调用？"><span class="toc-number">2.5.1.</span> <span class="toc-text">为什么叫快速调用？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#中断门-INT-0x2E进0环"><span class="toc-number">2.6.</span> <span class="toc-text">中断门 INT 0x2E进0环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sysenter进0环"><span class="toc-number">2.7.</span> <span class="toc-text">sysenter进0环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结："><span class="toc-number">2.8.</span> <span class="toc-text">总结：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、自己实现通过中断门直接调用内核函数。"><span class="toc-number">2.8.1.</span> <span class="toc-text">1、自己实现通过中断门直接调用内核函数。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#进0环后，原来的寄存器存在哪里？"><span class="toc-number">3.</span> <span class="toc-text">进0环后，原来的寄存器存在哪里？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料："><span class="toc-number">4.</span> <span class="toc-text">参考资料：</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/%E5%A4%B4%E5%83%8F/touxiang.jpg"></div><div class="author-info__name text-center">yangruiqi</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/yangruiqiyr" target="_blank">跟随我</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">28</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">41</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">相关网址</div><a class="author-info-links__name text-center" href="http://blog.topsec.com.cn/" target="_blank">天融信阿尔法实验室</a><a class="author-info-links__name text-center" href="https://www.baidu.com/" target="_blank">百度</a><a class="author-info-links__name text-center" href="https://bbs.pediy.com/" target="_blank">看雪</a><a class="author-info-links__name text-center" href="http://www.freebuf.com/" target="_blank">FreeBuf</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/主题/主题1.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">manyouyou</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">档案</a><a class="site-page" href="/tags">标题</a><a class="site-page" href="/categories">分类</a></span></div><div id="post-info"><div id="post-title">系统调用笔记上</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-06-30</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/笔记-系统调用笔记/">笔记 - 系统调用笔记</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="API函数的调用过程（3环部分）"><a href="#API函数的调用过程（3环部分）" class="headerlink" title="API函数的调用过程（3环部分）"></a>API函数的调用过程（3环部分）</h1><h2 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h2><ol>
<li>Application Programming Interface，简称 API 函数。</li>
<li><p>Windows有多少个API?<br>主要是存放在 C:\WINDOWS\system32 下面所有的dll，dll里面函数都是API</p>
</li>
<li><p>几个重要的DLL<br>Kernel32.dll:最核心的功能模块，比如管理内存、进程和线程相关的函数等.<br>User32.dll:是Windows用户界面相关应用程序接口,如创建窗口和发送消息等.<br>GDI32.dll:全称是Graphical Device Interface(图形设备接口),包含用于画图和显示文本的函数.比如要显示一个程序窗口，就调用了其中的函数来画这个窗口.<br>Ntdll.dll:大多数API都会通过这个DLL进入内核(0环).</p>
</li>
</ol>
<p>做实验找 ReadProcessMemory<br>首先打开IDA，打开kernelBase.dll（XP是kernel32.dll），按ATL+T，如下图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/1.png?x-oss-process=style/yangruiqi.com" alt="图1"></p>
<p>然后就打开了ReadProcessMemory，如下图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/2.png?x-oss-process=style/yangruiqi.com" alt="图二"><br>发现是调用了NtReadVirtualMemory。<br>再去import里面找这个函数就知道谁调用了他<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/3.png?x-oss-process=style/yangruiqi.com" alt="3"></p>
<p>发现时ntdll，然后去找ntdll,的这个函数<br>NtReadVirtualMemory<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/4.png?x-oss-process=style/yangruiqi.com" alt="4"><br>真正读取进程内存的函数在0环，在这里的114h是一个编号，这个编号，对应的是真正的操作系统内核中某个函数，所以我们的API进内核都需要一个编号，这个编号就是真正执行的函数。下面的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov edx,7FFE0300h</span><br></pre></td></tr></table></figure>
<p>这是一个内存地址，存了一个函数，这个函数觉得了用什么方式进0环，也就是这段代码就是找到一个编号通过一个函数（edx）进入0环。<br>所以3环的API函数都是提供一个进入0环的接口而已。   </p>
<h1 id="API函数的调用过程（3环进0环-上）"><a href="#API函数的调用过程（3环进0环-上）" class="headerlink" title="API函数的调用过程（3环进0环 上）"></a>API函数的调用过程（3环进0环 上）</h1><p>下面我们说一下上面的7FFE0300h函数是什么，所以先了解下0x7ffe0000这页内存是什么。</p>
<h2 id="KUSER-SHARED-DATA（Kernel和Use共享了一块数据）"><a href="#KUSER-SHARED-DATA（Kernel和Use共享了一块数据）" class="headerlink" title="_KUSER_SHARED_DATA（Kernel和Use共享了一块数据）"></a>_KUSER_SHARED_DATA（Kernel和Use共享了一块数据）</h2><p>这块任何一个3环的程序都可以访问，他的地址是确定的。地址如下</p>
<ol>
<li>在 User 层和 Kernel 层分别定义了一个 _KUSER_SHARED_DATA 结构区域，用于 User 层和 Kernel 层共享某些数据   </li>
<li>它们使用固定的地址值映射，_KUSER_SHARED_DATA 结构区域在 User 和 Kernel 层地址分别为：<ol>
<li>User 层地址为：0x7ffe0000   </li>
<li>Kernnel 层地址为：0xffdf0000  </li>
</ol>
</li>
</ol>
<p>这两个不同的线性地址，指向的是同一个物理页，区别就是0环通过这个线性地址对这块内存可读可写，但是3环是只读，虽然指向的是同一个物理页，但在User 层是只读的，在Kernnel层是可写的.<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/5XFT%24MTSEVTT3PC%7B0V_38%40P.png?x-oss-process=style/yangruiqi.com" alt="5"></p>
<p>如上图，查看下内容一样</p>
<h2 id="0x7FFE0300到底存储的是什么？"><a href="#0x7FFE0300到底存储的是什么？" class="headerlink" title="0x7FFE0300到底存储的是什么？"></a>0x7FFE0300到底存储的是什么？</h2><p>然后查看下_KUSER_SHARED_DATA这个内存<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/FM%60M1%7EA%7D3G%25PL6E%29LD2JKSC.png?x-oss-process=style/yangruiqi.com" alt="6"></p>
<p>查看到300处偏移就是一个叫SystemCall，这个位置存储的函数有两种情况：   </p>
<p>实验：是否支持快速调用</p>
<p>当通过eax=1来执行cpuid指令时，处理器的特征信息被放在ecx和edx寄存器中，其中edx包含了一个SEP位（11位），该位指明了当前处理器知否支持sysenter/sysexit指令</p>
<p>支持：<br>ntdll.dll!KiFastSystemCall()//这个不是内核函数，是ntdll的</p>
<p>不支持：<br>ntdll.dll!KiIntSystemCall()<br>实验如下，改eax=1，ecx，edx清0，命令改成CPUID</p>
<p><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/Z00%5D%5BD8IRJPWLRBM7DSX%254I.png?x-oss-process=style/yangruiqi.com" alt="7"><br>edx=0F8BFBFF，2进制是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">‭1111100010111111101111111111‬</span><br></pre></td></tr></table></figure></p>
<p>第11位是1，支持，支持时把KiFastSystemCall()写到300偏移处的地址上，不支持KiIntSystemCall()写过去   </p>
<h2 id="进0环需要更改哪些寄存器？"><a href="#进0环需要更改哪些寄存器？" class="headerlink" title="进0环需要更改哪些寄存器？"></a>进0环需要更改哪些寄存器？</h2><ol>
<li>CS的权限由3变为0  意味着需要新的CS</li>
</ol>
<p>2) SS与CS的权限永远一致 需要新的SS</p>
<p>3) 权限发生切换的时候，堆栈也一定会切换，需要新的ESP</p>
<p>4) 进0环后代码的位置，需要EIP  </p>
<h2 id="不支持快速调用时候，中断门进0环："><a href="#不支持快速调用时候，中断门进0环：" class="headerlink" title="不支持快速调用时候，中断门进0环："></a>不支持快速调用时候，中断门进0环：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:77F070C0                 public KiIntSystemCall</span><br><span class="line">.text:77F070C0 KiIntSystemCall proc near               ; DATA XREF: .text:off_77EF61B8o</span><br><span class="line">.text:77F070C0</span><br><span class="line">.text:77F070C0 arg_4           = byte ptr  8</span><br><span class="line">.text:77F070C0</span><br><span class="line">.text:77F070C0                 lea     edx, [esp+arg_4]//edx是参数指针，系统调用号在eax寄存器</span><br><span class="line">.text:77F070C4                 int     2Eh             ; DOS 2+ internal - EXECUTE COMMAND</span><br><span class="line">.text:77F070C4                                         ; DS:SI -&gt; counted CR-terminated command string</span><br><span class="line">.text:77F070C6                 retn</span><br><span class="line">.text:77F070C6 KiIntSystemCall endp</span><br></pre></td></tr></table></figure>
<p>就2行，把当前函数参数地址存到edx，我们之前往eax存了个内核函数编号，直接通过中断门进入内核。    </p>
<h2 id="当CPU支持快速调用时候"><a href="#当CPU支持快速调用时候" class="headerlink" title="当CPU支持快速调用时候"></a>当CPU支持快速调用时候</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">text:77F070B0 KiFastSystemCall proc near              ; DATA XREF: .text:off_77EF61B8o</span><br><span class="line">.text:77F070B0                 mov     edx, esp</span><br><span class="line">.text:77F070B2                 sysenter</span><br></pre></td></tr></table></figure>
<p>edx是参数，eax还是编号，没用中断门了，用的sysenter</p>
<h3 id="为什么叫快速调用？"><a href="#为什么叫快速调用？" class="headerlink" title="为什么叫快速调用？"></a>为什么叫快速调用？</h3><p>中断门进0环，需要的CS、EIP在IDT表中，需要查内存(SS与ESP由TSS提供)，比较慢<br>而CPU如果支持sysenter指令时，操作系统会提前将CS/SS/ESP/EIP的值存储在MSR寄存器中，sysenter指令执行时，CPU会将MSR寄存器中的值直接写入相关<br>寄存器，没有读内存的过程，所以叫快速调用，本质是一样的！</p>
<h2 id="中断门-INT-0x2E进0环"><a href="#中断门-INT-0x2E进0环" class="headerlink" title="中断门 INT 0x2E进0环"></a>中断门 INT 0x2E进0环</h2><p>步骤一：在IDT表中找到0x2E号门描述符</p>
<p>步骤二：分析CS/SS/ESP/EIP的来源</p>
<p>步骤三：分析EIP是什么</p>
<p>所以做如下实验：   </p>
<p>通过windbg先查看IDT表，然后找到2Eh也就是第46项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq 80b95400 l40</span><br><span class="line">80b95400  83e48e00`00080fc0 83e48e00`00081150</span><br><span class="line">80b95410  00008500`00580000 83e4ee00`000815c0</span><br><span class="line">80b95420  83e4ee00`00081748 83e48e00`000818a8</span><br><span class="line">80b95430  83e48e00`00081a1c 83e48e00`00082018</span><br><span class="line">80b95440  00008500`00500000 83e48e00`00082478</span><br><span class="line">80b95450  83e48e00`0008259c 83e48e00`000826dc</span><br><span class="line">80b95460  83e48e00`0008293c 83e48e00`00082c2c</span><br><span class="line">80b95470  83e48e00`000832fc 83e48e00`000836b0</span><br><span class="line">80b95480  83e48e00`000837d4 83e48e00`00083914</span><br><span class="line">80b95490  00008500`00a00000 83e48e00`00083a80</span><br><span class="line">80b954a0  83e48e00`000836b0 83e48e00`000836b0</span><br><span class="line">80b954b0  83e48e00`000836b0 83e48e00`000836b0</span><br><span class="line">80b954c0  83e48e00`000836b0 83e48e00`000836b0</span><br><span class="line">80b954d0  83e48e00`000836b0 83e48e00`000836b0</span><br><span class="line">80b954e0  83e48e00`000836b0 83e48e00`000836b0</span><br><span class="line">80b954f0  83e48e00`000836b0 84228e00`0008eaf8</span><br><span class="line">80b95500  00000000`00080000 00000000`00080000</span><br><span class="line">80b95510  00000000`00080000 00000000`00080000</span><br><span class="line">80b95520  00000000`00080000 00000000`00080000</span><br><span class="line">80b95530  00000000`00080000 00000000`00080000</span><br><span class="line">80b95540  00000000`00080000 00000000`00080000</span><br><span class="line">80b95550  83e4ee00`0008063a 83e4ee00`000807c0</span><br><span class="line">80b95560  83e4ee00`000808fc 83e4ee00`00081498</span><br><span class="line">80b95570  83e3ee00`0008ffee 83e48e00`000836b0</span><br><span class="line">80b95580  83e38e00`0008f6b0 83e38e00`0008f6ba</span><br><span class="line">80b95590  83e38e00`0008f6c4 83e38e00`0008f6ce</span><br><span class="line">80b955a0  83e38e00`0008f6d8 83e38e00`0008f6e2</span><br><span class="line">80b955b0  83e38e00`0008f6ec 84228e00`0008e104</span><br><span class="line">80b955c0  83e38e00`0008f700 83e38e00`0008f70a</span><br><span class="line">80b955d0  83e38e00`0008f714 83e38e00`0008f71e</span><br><span class="line">80b955e0  83e38e00`0008f728 83e38e00`0008f732</span><br><span class="line">80b955f0  83e38e00`0008f73c 83e38e00`0008f746</span><br></pre></td></tr></table></figure></p>
<p>所以通过中断门进入0环就是83e3ee00`0008ffee，</p>
<p>根据描述符，是中断门，代码段选择子cs是0008，要执行的EIP是前后2字节83e3ffee,ss,esp由TSS得的，下面分析进入0环时候，代码从哪开始执行，用U可以对地址反汇编。<br>所以通过中断门进入0环要执行的函数是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; u 83e3ffee</span><br><span class="line">nt!KiSystemService://nt,所以是真正的内核模块了</span><br><span class="line">83e3ffee 6a00            push    0</span><br><span class="line">83e3fff0 55              push    ebp</span><br><span class="line">83e3fff1 53              push    ebx</span><br><span class="line">83e3fff2 56              push    esi</span><br><span class="line">83e3fff3 57              push    edi</span><br><span class="line">83e3fff4 0fa0            push    fs</span><br><span class="line">83e3fff6 bb30000000      mov     ebx,30h</span><br><span class="line">83e3fffb 668ee3          mov     fs,bx</span><br></pre></td></tr></table></figure>
<h2 id="sysenter进0环"><a href="#sysenter进0环" class="headerlink" title="sysenter进0环"></a>sysenter进0环</h2><p>因为通过sysenter进0环省略查找IDT，TSS表的步骤，所以快，所以这些信息在执行sysenter指令之前，操作系统必须指定0环的CS段、SS段、EIP以及ESP，存在MSR寄存器里<br>MSR | 地址<br>—|—<br>IA32_SYSENTER_CS | 174H<br>IA32_SYSENTER_ESP | 175H<br>IA32_SYSENTER_EIP|176H</p>
<p>可以通过RDMSR/WRMST来进行读写（操作系统使用WRMST写该寄存器）:</p>
<p>kd&gt; rdmsr 174   //查看CS，cs+8就是ss选择子<br>kd&gt; rdmsr 175   //查看ESP<br>kd&gt; rdmsr 176   //查看EIP   </p>
<p>参考：Intel白皮书第二卷(搜索sysenter)<br>这些都是硬件CPU做的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; rdmsr 174</span><br><span class="line">msr[174] = 00000000`00000008</span><br><span class="line">kd&gt; rdmst 175</span><br><span class="line">        ^ Bad register error in &apos;rdmst 175&apos;</span><br><span class="line">kd&gt; rdmsr 175</span><br><span class="line">msr[175] = 00000000`80792000</span><br><span class="line">kd&gt; rdmsr 176</span><br><span class="line">msr[176] = 00000000`83e400c0</span><br><span class="line">kd&gt; u 83e400c0</span><br><span class="line">nt!KiFastCallEntry:</span><br><span class="line">83e400c0 b923000000      mov     ecx,23h</span><br><span class="line">83e400c5 6a30            push    30h</span><br><span class="line">83e400c7 0fa1            pop     fs</span><br><span class="line">83e400c9 8ed9            mov     ds,cx</span><br><span class="line">83e400cb 8ec1            mov     es,cx</span><br><span class="line">83e400cd 648b0d40000000  mov     ecx,dword ptr fs:[40h]</span><br><span class="line">83e400d4 8b6104          mov     esp,dword ptr [ecx+4]</span><br><span class="line">83e400d7 6a23            push    23h</span><br></pre></td></tr></table></figure>
<p>根据查看通过sysenter进入0环，用的函数是KiFastCallEntry   </p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>API通过中断门进0环：</p>
<pre><code>1)  固定中断号为0x2E
2)  CS/EIP由门描述符提供   ESP/SS由TSS提供
3)  进入0环后执行的内核函数：NT!KiSystemService
</code></pre><p>API通过sysenter指令进0环：</p>
<pre><code>1)  CS/ESP/EIP由MSR寄存器提供(SS是算出来的)
2)  进入0环后执行的内核函数：NT!KiFastCallEntry
</code></pre><p>内核模块：ntoskrnl.exe/ntkrnlpa.exe   </p>
<h3 id="1、自己实现通过中断门直接调用内核函数。"><a href="#1、自己实现通过中断门直接调用内核函数。" class="headerlink" title="1、自己实现通过中断门直接调用内核函数。"></a>1、自己实现通过中断门直接调用内核函数。</h3><p>Call XXXXEE000008XXXX//xxxx是内核函数地址偏移，让Eax等于调用号，然后调KiSystemService和KiFastCallEntry，E是构造了个1110，是p位有效，11是3环就能访问我，0是系统段。   </p>
<h1 id="进0环后，原来的寄存器存在哪里？"><a href="#进0环后，原来的寄存器存在哪里？" class="headerlink" title="进0环后，原来的寄存器存在哪里？"></a>进0环后，原来的寄存器存在哪里？</h1><p>拿KiSystemService举例。<br>首先要认识几个结构体：<br>Trap_Frame结构：<br>不论通过中断门和快速调用进入0环，所有寄存器都存这。   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _Ktrap_frame</span><br><span class="line">ntdll!_KTRAP_FRAME</span><br><span class="line">   +0x000 DbgEbp           : Uint4B</span><br><span class="line">   +0x004 DbgEip           : Uint4B</span><br><span class="line">   +0x008 DbgArgMark       : Uint4B</span><br><span class="line">   +0x00c DbgArgPointer    : Uint4B</span><br><span class="line">   +0x010 TempSegCs        : Uint2B</span><br><span class="line">   +0x012 Logging          : UChar</span><br><span class="line">   +0x013 Reserved         : UChar</span><br><span class="line">   +0x014 TempEsp          : Uint4B</span><br><span class="line">   +0x018 Dr0              : Uint4B</span><br><span class="line">   +0x01c Dr1              : Uint4B</span><br><span class="line">   +0x020 Dr2              : Uint4B</span><br><span class="line">   +0x024 Dr3              : Uint4B</span><br><span class="line">   +0x028 Dr6              : Uint4B</span><br><span class="line">   +0x02c Dr7              : Uint4B</span><br><span class="line">   +0x030 SegGs            : Uint4B</span><br><span class="line">   +0x034 SegEs            : Uint4B</span><br><span class="line">   +0x038 SegDs            : Uint4B</span><br><span class="line">   +0x03c Edx              : Uint4B</span><br><span class="line">   +0x040 Ecx              : Uint4B</span><br><span class="line">   +0x044 Eax              : Uint4B</span><br><span class="line">   +0x048 PreviousPreviousMode : Uint4B</span><br><span class="line">   +0x04c ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +0x050 SegFs            : Uint4B</span><br><span class="line">   +0x054 Edi              : Uint4B</span><br><span class="line">   +0x058 Esi              : Uint4B</span><br><span class="line">   +0x05c Ebx              : Uint4B</span><br><span class="line">   +0x060 Ebp              : Uint4B</span><br><span class="line">   +0x064 ErrCode          : Uint4B</span><br><span class="line">   +0x068 Eip              : Uint4B</span><br><span class="line">   +0x06c SegCs            : Uint4B</span><br><span class="line">   +0x070 EFlags           : Uint4B</span><br><span class="line">   +0x074 HardwareEsp      : Uint4B</span><br><span class="line">   +0x078 HardwareSegSs    : Uint4B</span><br><span class="line">   +0x07c V86Es            : Uint4B</span><br><span class="line">   +0x080 V86Ds            : Uint4B</span><br><span class="line">   +0x084 V86Fs            : Uint4B</span><br><span class="line">   +0x088 V86Gs            : Uint4B</span><br></pre></td></tr></table></figure>
<p>ETHREAD线程相关的结构体。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">ntdll!_ETHREAD</span><br><span class="line">   +0x000 Tcb              : _KTHREAD</span><br><span class="line">   +0x200 CreateTime       : _LARGE_INTEGER</span><br><span class="line">   +0x208 ExitTime         : _LARGE_INTEGER</span><br><span class="line">   +0x208 KeyedWaitChain   : _LIST_ENTRY</span><br><span class="line">   +0x210 ExitStatus       : Int4B</span><br><span class="line">   +0x214 PostBlockList    : _LIST_ENTRY</span><br><span class="line">   +0x214 ForwardLinkShadow : Ptr32 Void</span><br><span class="line">   +0x218 StartAddress     : Ptr32 Void</span><br><span class="line">   +0x21c TerminationPort  : Ptr32 _TERMINATION_PORT</span><br><span class="line">   +0x21c ReaperLink       : Ptr32 _ETHREAD</span><br><span class="line">   +0x21c KeyedWaitValue   : Ptr32 Void</span><br><span class="line">   +0x220 ActiveTimerListLock : Uint4B</span><br><span class="line">   +0x224 ActiveTimerListHead : _LIST_ENTRY</span><br><span class="line">   +0x22c Cid              : _CLIENT_ID</span><br><span class="line">   +0x234 KeyedWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +0x234 AlpcWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +0x248 ClientSecurity   : _PS_CLIENT_SECURITY_CONTEXT</span><br><span class="line">   +0x24c IrpList          : _LIST_ENTRY</span><br><span class="line">   +0x254 TopLevelIrp      : Uint4B</span><br><span class="line">   +0x258 DeviceToVerify   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +0x25c CpuQuotaApc      : Ptr32 _PSP_CPU_QUOTA_APC</span><br><span class="line">   +0x260 Win32StartAddress : Ptr32 Void</span><br><span class="line">   +0x264 LegacyPowerObject : Ptr32 Void</span><br><span class="line">   +0x268 ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +0x270 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +0x274 ThreadLock       : _EX_PUSH_LOCK</span><br><span class="line">   +0x278 ReadClusterSize  : Uint4B</span><br><span class="line">   +0x27c MmLockOrdering   : Int4B</span><br><span class="line">   +0x280 CrossThreadFlags : Uint4B</span><br><span class="line">   +0x280 Terminated       : Pos 0, 1 Bit</span><br><span class="line">   +0x280 ThreadInserted   : Pos 1, 1 Bit</span><br><span class="line">   +0x280 HideFromDebugger : Pos 2, 1 Bit</span><br><span class="line">   +0x280 ActiveImpersonationInfo : Pos 3, 1 Bit</span><br><span class="line">   +0x280 Reserved         : Pos 4, 1 Bit</span><br><span class="line">   +0x280 HardErrorsAreDisabled : Pos 5, 1 Bit</span><br><span class="line">   +0x280 BreakOnTermination : Pos 6, 1 Bit</span><br><span class="line">   +0x280 SkipCreationMsg  : Pos 7, 1 Bit</span><br><span class="line">   +0x280 SkipTerminationMsg : Pos 8, 1 Bit</span><br><span class="line">   +0x280 CopyTokenOnOpen  : Pos 9, 1 Bit</span><br><span class="line">   +0x280 ThreadIoPriority : Pos 10, 3 Bits</span><br><span class="line">   +0x280 ThreadPagePriority : Pos 13, 3 Bits</span><br><span class="line">   +0x280 RundownFail      : Pos 16, 1 Bit</span><br><span class="line">   +0x280 NeedsWorkingSetAging : Pos 17, 1 Bit</span><br><span class="line">   +0x284 SameThreadPassiveFlags : Uint4B</span><br><span class="line">   +0x284 ActiveExWorker   : Pos 0, 1 Bit</span><br><span class="line">   +0x284 ExWorkerCanWaitUser : Pos 1, 1 Bit</span><br><span class="line">   +0x284 MemoryMaker      : Pos 2, 1 Bit</span><br><span class="line">   +0x284 ClonedThread     : Pos 3, 1 Bit</span><br><span class="line">   +0x284 KeyedEventInUse  : Pos 4, 1 Bit</span><br><span class="line">   +0x284 RateApcState     : Pos 5, 2 Bits</span><br><span class="line">   +0x284 SelfTerminate    : Pos 7, 1 Bit</span><br><span class="line">   +0x288 SameThreadApcFlags : Uint4B</span><br><span class="line">   +0x288 Spare            : Pos 0, 1 Bit</span><br><span class="line">   +0x288 StartAddressInvalid : Pos 1, 1 Bit</span><br><span class="line">   +0x288 EtwPageFaultCalloutActive : Pos 2, 1 Bit</span><br><span class="line">   +0x288 OwnsProcessWorkingSetExclusive : Pos 3, 1 Bit</span><br><span class="line">   +0x288 OwnsProcessWorkingSetShared : Pos 4, 1 Bit</span><br><span class="line">   +0x288 OwnsSystemCacheWorkingSetExclusive : Pos 5, 1 Bit</span><br><span class="line">   +0x288 OwnsSystemCacheWorkingSetShared : Pos 6, 1 Bit</span><br><span class="line">   +0x288 OwnsSessionWorkingSetExclusive : Pos 7, 1 Bit</span><br><span class="line">   +0x289 OwnsSessionWorkingSetShared : Pos 0, 1 Bit</span><br><span class="line">   +0x289 OwnsProcessAddressSpaceExclusive : Pos 1, 1 Bit</span><br><span class="line">   +0x289 OwnsProcessAddressSpaceShared : Pos 2, 1 Bit</span><br><span class="line">   +0x289 SuppressSymbolLoad : Pos 3, 1 Bit</span><br><span class="line">   +0x289 Prefetching      : Pos 4, 1 Bit</span><br><span class="line">   +0x289 OwnsDynamicMemoryShared : Pos 5, 1 Bit</span><br><span class="line">   +0x289 OwnsChangeControlAreaExclusive : Pos 6, 1 Bit</span><br><span class="line">   +0x289 OwnsChangeControlAreaShared : Pos 7, 1 Bit</span><br><span class="line">   +0x28a OwnsPagedPoolWorkingSetExclusive : Pos 0, 1 Bit</span><br><span class="line">   +0x28a OwnsPagedPoolWorkingSetShared : Pos 1, 1 Bit</span><br><span class="line">   +0x28a OwnsSystemPtesWorkingSetExclusive : Pos 2, 1 Bit</span><br><span class="line">   +0x28a OwnsSystemPtesWorkingSetShared : Pos 3, 1 Bit</span><br><span class="line">   +0x28a TrimTrigger      : Pos 4, 2 Bits</span><br><span class="line">   +0x28a Spare1           : Pos 6, 2 Bits</span><br><span class="line">   +0x28b PriorityRegionActive : UChar</span><br><span class="line">   +0x28c CacheManagerActive : UChar</span><br><span class="line">   +0x28d DisablePageFaultClustering : UChar</span><br><span class="line">   +0x28e ActiveFaultCount : UChar</span><br><span class="line">   +0x28f LockOrderState   : UChar</span><br><span class="line">   +0x290 AlpcMessageId    : Uint4B</span><br><span class="line">   +0x294 AlpcMessage      : Ptr32 Void</span><br><span class="line">   +0x294 AlpcReceiveAttributeSet : Uint4B</span><br><span class="line">   +0x298 AlpcWaitListEntry : _LIST_ENTRY</span><br><span class="line">   +0x2a0 CacheManagerCount : Uint4B</span><br><span class="line">   +0x2a4 IoBoostCount     : Uint4B</span><br><span class="line">   +0x2a8 IrpListLock      : Uint4B</span><br><span class="line">   +0x2ac ReservedForSynchTracking : Ptr32 Void</span><br><span class="line">   +0x2b0 CmCallbackListHead : _SINGLE_LIST_ENTRY</span><br></pre></td></tr></table></figure>
<p>上面的结构体有个相对比较重要的结构体，KTHREAD如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KTHREAD</span><br><span class="line">ntdll!_KTHREAD</span><br><span class="line">   +0x000 Header           : _DISPATCHER_HEADER</span><br><span class="line">   上面这个可以拆解会用到03DebugActive</span><br><span class="line">   </span><br><span class="line">   kd&gt; dt _DISPATCHER_HEADER</span><br><span class="line">ntdll!_DISPATCHER_HEADER</span><br><span class="line">   +0x000 Type             : UChar</span><br><span class="line">   +0x001 TimerControlFlags : UChar</span><br><span class="line">   +0x001 Absolute         : Pos 0, 1 Bit</span><br><span class="line">   +0x001 Coalescable      : Pos 1, 1 Bit</span><br><span class="line">   +0x001 KeepShifting     : Pos 2, 1 Bit</span><br><span class="line">   +0x001 EncodedTolerableDelay : Pos 3, 5 Bits</span><br><span class="line">   +0x001 Abandoned        : UChar</span><br><span class="line">   +0x001 Signalling       : UChar</span><br><span class="line">   +0x002 ThreadControlFlags : UChar</span><br><span class="line">   +0x002 CpuThrottled     : Pos 0, 1 Bit</span><br><span class="line">   +0x002 CycleProfiling   : Pos 1, 1 Bit</span><br><span class="line">   +0x002 CounterProfiling : Pos 2, 1 Bit</span><br><span class="line">   +0x002 Reserved         : Pos 3, 5 Bits</span><br><span class="line">   +0x002 Hand             : UChar</span><br><span class="line">   +0x002 Size             : UChar</span><br><span class="line">   +0x003 TimerMiscFlags   : UChar</span><br><span class="line">   +0x003 Index            : Pos 0, 1 Bit</span><br><span class="line">   +0x003 Processor        : Pos 1, 5 Bits</span><br><span class="line">   +0x003 Inserted         : Pos 6, 1 Bit</span><br><span class="line">   +0x003 Expired          : Pos 7, 1 Bit</span><br><span class="line">   +0x003 DebugActive      : UChar</span><br><span class="line">   +0x003 ActiveDR7        : Pos 0, 1 Bit</span><br><span class="line">   +0x003 Instrumented     : Pos 1, 1 Bit</span><br><span class="line">   +0x003 Reserved2        : Pos 2, 4 Bits</span><br><span class="line">   +0x003 UmsScheduled     : Pos 6, 1 Bit</span><br><span class="line">   +0x003 UmsPrimary       : Pos 7, 1 Bit</span><br><span class="line">   +0x003 DpcActive        : UChar</span><br><span class="line">   +0x000 Lock             : Int4B</span><br><span class="line">   +0x004 SignalState      : Int4B</span><br><span class="line">   +0x008 WaitListHead     : _LIST_ENTRY</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   +0x010 CycleTime        : Uint8B</span><br><span class="line">   +0x018 HighCycleTime    : Uint4B</span><br><span class="line">   +0x020 QuantumTarget    : Uint8B</span><br><span class="line">   +0x028 InitialStack     : Ptr32 Void</span><br><span class="line">   +0x02c StackLimit       : Ptr32 Void</span><br><span class="line">   +0x030 KernelStack      : Ptr32 Void</span><br><span class="line">   +0x034 ThreadLock       : Uint4B</span><br><span class="line">   +0x038 WaitRegister     : _KWAIT_STATUS_REGISTER</span><br><span class="line">   +0x039 Running          : UChar</span><br><span class="line">   +0x03a Alerted          : [2] UChar</span><br><span class="line">   +0x03c KernelStackResident : Pos 0, 1 Bit</span><br><span class="line">   +0x03c ReadyTransition  : Pos 1, 1 Bit</span><br><span class="line">   +0x03c ProcessReadyQueue : Pos 2, 1 Bit</span><br><span class="line">   +0x03c WaitNext         : Pos 3, 1 Bit</span><br><span class="line">   +0x03c SystemAffinityActive : Pos 4, 1 Bit</span><br><span class="line">   +0x03c Alertable        : Pos 5, 1 Bit</span><br><span class="line">   +0x03c GdiFlushActive   : Pos 6, 1 Bit</span><br><span class="line">   +0x03c UserStackWalkActive : Pos 7, 1 Bit</span><br><span class="line">   +0x03c ApcInterruptRequest : Pos 8, 1 Bit</span><br><span class="line">   +0x03c ForceDeferSchedule : Pos 9, 1 Bit</span><br><span class="line">   +0x03c QuantumEndMigrate : Pos 10, 1 Bit</span><br><span class="line">   +0x03c UmsDirectedSwitchEnable : Pos 11, 1 Bit</span><br><span class="line">   +0x03c TimerActive      : Pos 12, 1 Bit</span><br><span class="line">   +0x03c SystemThread     : Pos 13, 1 Bit</span><br><span class="line">   +0x03c Reserved         : Pos 14, 18 Bits</span><br><span class="line">   +0x03c MiscFlags        : Int4B</span><br><span class="line">   +0x040 ApcState         : _KAPC_STATE</span><br><span class="line">   +0x040 ApcStateFill     : [23] UChar</span><br><span class="line">   +0x057 Priority         : Char</span><br><span class="line">   +0x058 NextProcessor    : Uint4B</span><br><span class="line">   +0x05c DeferredProcessor : Uint4B</span><br><span class="line">   +0x060 ApcQueueLock     : Uint4B</span><br><span class="line">   +0x064 ContextSwitches  : Uint4B</span><br><span class="line">   +0x068 State            : UChar</span><br><span class="line">   +0x069 NpxState         : Char</span><br><span class="line">   +0x06a WaitIrql         : UChar</span><br><span class="line">   +0x06b WaitMode         : Char</span><br><span class="line">   +0x06c WaitStatus       : Int4B</span><br><span class="line">   +0x070 WaitBlockList    : Ptr32 _KWAIT_BLOCK</span><br><span class="line">   +0x074 WaitListEntry    : _LIST_ENTRY</span><br><span class="line">   +0x074 SwapListEntry    : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x07c Queue            : Ptr32 _KQUEUE</span><br><span class="line">   +0x080 WaitTime         : Uint4B</span><br><span class="line">   +0x084 KernelApcDisable : Int2B</span><br><span class="line">   +0x086 SpecialApcDisable : Int2B</span><br><span class="line">   +0x084 CombinedApcDisable : Uint4B</span><br><span class="line">   +0x088 Teb              : Ptr32 Void</span><br><span class="line">   +0x090 Timer            : _KTIMER</span><br><span class="line">   +0x0b8 AutoAlignment    : Pos 0, 1 Bit</span><br><span class="line">   +0x0b8 DisableBoost     : Pos 1, 1 Bit</span><br><span class="line">   +0x0b8 EtwStackTraceApc1Inserted : Pos 2, 1 Bit</span><br><span class="line">   +0x0b8 EtwStackTraceApc2Inserted : Pos 3, 1 Bit</span><br><span class="line">   +0x0b8 CalloutActive    : Pos 4, 1 Bit</span><br><span class="line">   +0x0b8 ApcQueueable     : Pos 5, 1 Bit</span><br><span class="line">   +0x0b8 EnableStackSwap  : Pos 6, 1 Bit</span><br><span class="line">   +0x0b8 GuiThread        : Pos 7, 1 Bit</span><br><span class="line">   +0x0b8 UmsPerformingSyscall : Pos 8, 1 Bit</span><br><span class="line">   +0x0b8 VdmSafe          : Pos 9, 1 Bit</span><br><span class="line">   +0x0b8 UmsDispatched    : Pos 10, 1 Bit</span><br><span class="line">   +0x0b8 ReservedFlags    : Pos 11, 21 Bits</span><br><span class="line">   +0x0b8 ThreadFlags      : Int4B</span><br><span class="line">   +0x0bc ServiceTable     : Ptr32 Void</span><br><span class="line">   +0x0c0 WaitBlock        : [4] _KWAIT_BLOCK</span><br><span class="line">   +0x120 QueueListEntry   : _LIST_ENTRY</span><br><span class="line">   +0x128 TrapFrame        : Ptr32 _KTRAP_FRAME</span><br><span class="line">   +0x12c FirstArgument    : Ptr32 Void</span><br><span class="line">   +0x130 CallbackStack    : Ptr32 Void</span><br><span class="line">   +0x130 CallbackDepth    : Uint4B</span><br><span class="line">   +0x134 ApcStateIndex    : UChar</span><br><span class="line">   +0x135 BasePriority     : Char</span><br><span class="line">   +0x136 PriorityDecrement : Char</span><br><span class="line">   +0x136 ForegroundBoost  : Pos 0, 4 Bits</span><br><span class="line">   +0x136 UnusualBoost     : Pos 4, 4 Bits</span><br><span class="line">   +0x137 Preempted        : UChar</span><br><span class="line">   +0x138 AdjustReason     : UChar</span><br><span class="line">   +0x139 AdjustIncrement  : Char</span><br><span class="line">   +0x13a PreviousMode     : Char</span><br><span class="line">   +0x13b Saturation       : Char</span><br><span class="line">   +0x13c SystemCallNumber : Uint4B</span><br><span class="line">   +0x140 FreezeCount      : Uint4B</span><br><span class="line">   +0x144 UserAffinity     : _GROUP_AFFINITY</span><br><span class="line">   +0x150 Process          : Ptr32 _KPROCESS</span><br><span class="line">   +0x154 Affinity         : _GROUP_AFFINITY</span><br><span class="line">   +0x160 IdealProcessor   : Uint4B</span><br><span class="line">   +0x164 UserIdealProcessor : Uint4B</span><br><span class="line">   +0x168 ApcStatePointer  : [2] Ptr32 _KAPC_STATE</span><br><span class="line">   +0x170 SavedApcState    : _KAPC_STATE</span><br><span class="line">   +0x170 SavedApcStateFill : [23] UChar</span><br><span class="line">   +0x187 WaitReason       : UChar</span><br><span class="line">   +0x188 SuspendCount     : Char</span><br><span class="line">   +0x189 Spare1           : Char</span><br><span class="line">   +0x18a OtherPlatformFill : UChar</span><br><span class="line">   +0x18c Win32Thread      : Ptr32 Void</span><br><span class="line">   +0x190 StackBase        : Ptr32 Void</span><br><span class="line">   +0x194 SuspendApc       : _KAPC</span><br><span class="line">   +0x194 SuspendApcFill0  : [1] UChar</span><br><span class="line">   +0x195 ResourceIndex    : UChar</span><br><span class="line">   +0x194 SuspendApcFill1  : [3] UChar</span><br><span class="line">   +0x197 QuantumReset     : UChar</span><br><span class="line">   +0x194 SuspendApcFill2  : [4] UChar</span><br><span class="line">   +0x198 KernelTime       : Uint4B</span><br><span class="line">   +0x194 SuspendApcFill3  : [36] UChar</span><br><span class="line">   +0x1b8 WaitPrcb         : Ptr32 _KPRCB</span><br><span class="line">   +0x194 SuspendApcFill4  : [40] UChar</span><br><span class="line">   +0x1bc LegoData         : Ptr32 Void</span><br><span class="line">   +0x194 SuspendApcFill5  : [47] UChar</span><br><span class="line">   +0x1c3 LargeStack       : UChar</span><br><span class="line">   +0x1c4 UserTime         : Uint4B</span><br><span class="line">   +0x1c8 SuspendSemaphore : _KSEMAPHORE</span><br><span class="line">   +0x1c8 SuspendSemaphorefill : [20] UChar</span><br><span class="line">   +0x1dc SListFaultCount  : Uint4B</span><br><span class="line">   +0x1e0 ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +0x1e8 MutantListHead   : _LIST_ENTRY</span><br><span class="line">   +0x1f0 SListFaultAddress : Ptr32 Void</span><br><span class="line">   +0x1f4 ThreadCounters   : Ptr32 _KTHREAD_COUNTERS</span><br><span class="line">   +0x1f8 XStateSave       : Ptr32 _XSTATE_SAVE</span><br></pre></td></tr></table></figure>
<p>线程有一个结构体描述他的状态如上，CPU也有是PCR<br>即CPU控制区（Process Control Region）<br>CPU也有自己的控制块，每一个CPU有一个，叫KPCR，有几个核就几个<br>查看CPU数量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd KeNumberProcessors</span><br><span class="line">83f6c96c  00000001 83ef8f33 00000002 00000001</span><br><span class="line">83f6c97c  00000000 00000000 00000020 1fc10000</span><br><span class="line">83f6c98c  00110006 00003c03 77ab7058 77ab6f58</span><br><span class="line">83f6c99c  77ab6fc0 77ab7008 77aa5a8f 77aa5a8d</span><br><span class="line">83f6c9ac  77aa5a64 00000000 00c671e3 841c55b0</span><br><span class="line">83f6c9bc  8412f4f2 83e80d9c 00000000 00000191</span><br><span class="line">83f6c9cc  83e813e4 00000000 00000000 00000000</span><br><span class="line">83f6c9dc  00000000 83edf6af 00000000 025355a9</span><br></pre></td></tr></table></figure>
<p>还可以通过下面命令查看当前的KPCR存在哪，有几核就几个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd KiProcessorBlock L8//显示一个说明单核</span><br><span class="line">83f6c8c0  83f2dd20 00000000 00000000 00000000</span><br><span class="line">83f6c8d0  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">dt _KPCR</span><br><span class="line">ntdll!_KPCR</span><br><span class="line">   +0x000 NtTib            : _NT_TIB</span><br><span class="line">   +0x000 Used_ExceptionList : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +0x004 Used_StackBase   : Ptr32 Void</span><br><span class="line">   +0x008 Spare2           : Ptr32 Void</span><br><span class="line">   +0x00c TssCopy          : Ptr32 Void</span><br><span class="line">   +0x010 ContextSwitches  : Uint4B</span><br><span class="line">   +0x014 SetMemberCopy    : Uint4B</span><br><span class="line">   +0x018 Used_Self        : Ptr32 Void</span><br><span class="line">   +0x01c SelfPcr          : Ptr32 _KPCR</span><br><span class="line">   +0x020 Prcb             : Ptr32 _KPRCB</span><br><span class="line">   +0x024 Irql             : UChar</span><br><span class="line">   +0x028 IRR              : Uint4B</span><br><span class="line">   +0x02c IrrActive        : Uint4B</span><br><span class="line">   +0x030 IDR              : Uint4B</span><br><span class="line">   +0x034 KdVersionBlock   : Ptr32 Void</span><br><span class="line">   +0x038 IDT              : Ptr32 _KIDTENTRY</span><br><span class="line">   +0x03c GDT              : Ptr32 _KGDTENTRY</span><br><span class="line">   +0x040 TSS              : Ptr32 _KTSS</span><br><span class="line">   +0x044 MajorVersion     : Uint2B</span><br><span class="line">   +0x046 MinorVersion     : Uint2B</span><br><span class="line">   +0x048 SetMember        : Uint4B</span><br><span class="line">   +0x04c StallScaleFactor : Uint4B</span><br><span class="line">   +0x050 SpareUnused      : UChar</span><br><span class="line">   +0x051 Number           : UChar</span><br><span class="line">   +0x052 Spare0           : UChar</span><br><span class="line">   +0x053 SecondLevelCacheAssociativity : UChar</span><br><span class="line">   +0x054 VdmAlert         : Uint4B</span><br><span class="line">   +0x058 KernelReserved   : [14] Uint4B</span><br><span class="line">   +0x090 SecondLevelCacheSize : Uint4B</span><br><span class="line">   +0x094 HalReserved      : [16] Uint4B</span><br><span class="line">   +0x0d4 InterruptMode    : Uint4B</span><br><span class="line">   +0x0d8 Spare1           : UChar</span><br><span class="line">   +0x0dc KernelReserved2  : [17] Uint4B</span><br><span class="line">   +0x120 PrcbData         : _KPRCB</span><br></pre></td></tr></table></figure>
<p>最后一个_KPRCB结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPRCB</span><br><span class="line">ntdll!_KPRCB</span><br><span class="line">   +0x000 MinorVersion     : Uint2B</span><br><span class="line">   +0x002 MajorVersion     : Uint2B</span><br><span class="line">   +0x004 CurrentThread    : Ptr32 _KTHREAD</span><br><span class="line">   +0x008 NextThread       : Ptr32 _KTHREAD</span><br><span class="line">   +0x00c IdleThread       : Ptr32 _KTHREAD</span><br><span class="line">   +0x010 LegacyNumber     : UChar</span><br><span class="line">   +0x011 NestingLevel     : UChar</span><br><span class="line">   +0x012 BuildType        : Uint2B</span><br><span class="line">   +0x014 CpuType          : Char</span><br><span class="line">   +0x015 CpuID            : Char</span><br><span class="line">   +0x016 CpuStep          : Uint2B</span><br><span class="line">   +0x016 CpuStepping      : UChar</span><br><span class="line">   +0x017 CpuModel         : UChar</span><br><span class="line">   +0x018 ProcessorState   : _KPROCESSOR_STATE</span><br><span class="line">   +0x338 KernelReserved   : [16] Uint4B</span><br><span class="line">   +0x378 HalReserved      : [16] Uint4B</span><br><span class="line">   +0x3b8 CFlushSize       : Uint4B</span><br><span class="line">   +0x3bc CoresPerPhysicalProcessor : UChar</span><br><span class="line">   +0x3bd LogicalProcessorsPerCore : UChar</span><br><span class="line">   +0x3be PrcbPad0         : [2] UChar</span><br><span class="line">   +0x3c0 MHz              : Uint4B</span><br><span class="line">   +0x3c4 CpuVendor        : UChar</span><br><span class="line">   +0x3c5 GroupIndex       : UChar</span><br><span class="line">   +0x3c6 Group            : Uint2B</span><br><span class="line">   +0x3c8 GroupSetMember   : Uint4B</span><br><span class="line">   +0x3cc Number           : Uint4B</span><br><span class="line">   +0x3d0 PrcbPad1         : [72] UChar</span><br><span class="line">   +0x418 LockQueue        : [17] _KSPIN_LOCK_QUEUE</span><br><span class="line">   +0x4a0 NpxThread        : Ptr32 _KTHREAD</span><br><span class="line">   +0x4a4 InterruptCount   : Uint4B</span><br><span class="line">   +0x4a8 KernelTime       : Uint4B</span><br><span class="line">   +0x4ac UserTime         : Uint4B</span><br><span class="line">   +0x4b0 DpcTime          : Uint4B</span><br><span class="line">   +0x4b4 DpcTimeCount     : Uint4B</span><br><span class="line">   +0x4b8 InterruptTime    : Uint4B</span><br><span class="line">   +0x4bc AdjustDpcThreshold : Uint4B</span><br><span class="line">   +0x4c0 PageColor        : Uint4B</span><br><span class="line">   +0x4c4 DebuggerSavedIRQL : UChar</span><br><span class="line">   +0x4c5 NodeColor        : UChar</span><br><span class="line">   +0x4c6 PrcbPad20        : [2] UChar</span><br><span class="line">   +0x4c8 NodeShiftedColor : Uint4B</span><br><span class="line">   +0x4cc ParentNode       : Ptr32 _KNODE</span><br><span class="line">   +0x4d0 SecondaryColorMask : Uint4B</span><br><span class="line">   +0x4d4 DpcTimeLimit     : Uint4B</span><br><span class="line">   +0x4d8 PrcbPad21        : [2] Uint4B</span><br><span class="line">   +0x4e0 CcFastReadNoWait : Uint4B</span><br><span class="line">   +0x4e4 CcFastReadWait   : Uint4B</span><br><span class="line">   +0x4e8 CcFastReadNotPossible : Uint4B</span><br><span class="line">   +0x4ec CcCopyReadNoWait : Uint4B</span><br><span class="line">   +0x4f0 CcCopyReadWait   : Uint4B</span><br><span class="line">   +0x4f4 CcCopyReadNoWaitMiss : Uint4B</span><br><span class="line">   +0x4f8 MmSpinLockOrdering : Int4B</span><br><span class="line">   +0x4fc IoReadOperationCount : Int4B</span><br><span class="line">   +0x500 IoWriteOperationCount : Int4B</span><br><span class="line">   +0x504 IoOtherOperationCount : Int4B</span><br><span class="line">   +0x508 IoReadTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x510 IoWriteTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x518 IoOtherTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x520 CcFastMdlReadNoWait : Uint4B</span><br><span class="line">   +0x524 CcFastMdlReadWait : Uint4B</span><br><span class="line">   +0x528 CcFastMdlReadNotPossible : Uint4B</span><br><span class="line">   +0x52c CcMapDataNoWait  : Uint4B</span><br><span class="line">   +0x530 CcMapDataWait    : Uint4B</span><br><span class="line">   +0x534 CcPinMappedDataCount : Uint4B</span><br><span class="line">   +0x538 CcPinReadNoWait  : Uint4B</span><br><span class="line">   +0x53c CcPinReadWait    : Uint4B</span><br><span class="line">   +0x540 CcMdlReadNoWait  : Uint4B</span><br><span class="line">   +0x544 CcMdlReadWait    : Uint4B</span><br><span class="line">   +0x548 CcLazyWriteHotSpots : Uint4B</span><br><span class="line">   +0x54c CcLazyWriteIos   : Uint4B</span><br><span class="line">   +0x550 CcLazyWritePages : Uint4B</span><br><span class="line">   +0x554 CcDataFlushes    : Uint4B</span><br><span class="line">   +0x558 CcDataPages      : Uint4B</span><br><span class="line">   +0x55c CcLostDelayedWrites : Uint4B</span><br><span class="line">   +0x560 CcFastReadResourceMiss : Uint4B</span><br><span class="line">   +0x564 CcCopyReadWaitMiss : Uint4B</span><br><span class="line">   +0x568 CcFastMdlReadResourceMiss : Uint4B</span><br><span class="line">   +0x56c CcMapDataNoWaitMiss : Uint4B</span><br><span class="line">   +0x570 CcMapDataWaitMiss : Uint4B</span><br><span class="line">   +0x574 CcPinReadNoWaitMiss : Uint4B</span><br><span class="line">   +0x578 CcPinReadWaitMiss : Uint4B</span><br><span class="line">   +0x57c CcMdlReadNoWaitMiss : Uint4B</span><br><span class="line">   +0x580 CcMdlReadWaitMiss : Uint4B</span><br><span class="line">   +0x584 CcReadAheadIos   : Uint4B</span><br><span class="line">   +0x588 KeAlignmentFixupCount : Uint4B</span><br><span class="line">   +0x58c KeExceptionDispatchCount : Uint4B</span><br><span class="line">   +0x590 KeSystemCalls    : Uint4B</span><br><span class="line">   +0x594 AvailableTime    : Uint4B</span><br><span class="line">   +0x598 PrcbPad22        : [2] Uint4B</span><br><span class="line">   +0x5a0 PPLookasideList  : [16] _PP_LOOKASIDE_LIST</span><br><span class="line">   +0x620 PPNPagedLookasideList : [32] _GENERAL_LOOKASIDE_POOL</span><br><span class="line">   +0xf20 PPPagedLookasideList : [32] _GENERAL_LOOKASIDE_POOL</span><br><span class="line">   +0x1820 PacketBarrier    : Uint4B</span><br><span class="line">   +0x1824 ReverseStall     : Int4B</span><br><span class="line">   +0x1828 IpiFrame         : Ptr32 Void</span><br><span class="line">   +0x182c PrcbPad3         : [52] UChar</span><br><span class="line">   +0x1860 CurrentPacket    : [3] Ptr32 Void</span><br><span class="line">   +0x186c TargetSet        : Uint4B</span><br><span class="line">   +0x1870 WorkerRoutine    : Ptr32     void </span><br><span class="line">   +0x1874 IpiFrozen        : Uint4B</span><br><span class="line">   +0x1878 PrcbPad4         : [40] UChar</span><br><span class="line">   +0x18a0 RequestSummary   : Uint4B</span><br><span class="line">   +0x18a4 SignalDone       : Ptr32 _KPRCB</span><br><span class="line">   +0x18a8 PrcbPad50        : [56] UChar</span><br><span class="line">   +0x18e0 DpcData          : [2] _KDPC_DATA</span><br><span class="line">   +0x1908 DpcStack         : Ptr32 Void</span><br><span class="line">   +0x190c MaximumDpcQueueDepth : Int4B</span><br><span class="line">   +0x1910 DpcRequestRate   : Uint4B</span><br><span class="line">   +0x1914 MinimumDpcRate   : Uint4B</span><br><span class="line">   +0x1918 DpcLastCount     : Uint4B</span><br><span class="line">   +0x191c PrcbLock         : Uint4B</span><br><span class="line">   +0x1920 DpcGate          : _KGATE</span><br><span class="line">   +0x1930 ThreadDpcEnable  : UChar</span><br><span class="line">   +0x1931 QuantumEnd       : UChar</span><br><span class="line">   +0x1932 DpcRoutineActive : UChar</span><br><span class="line">   +0x1933 IdleSchedule     : UChar</span><br><span class="line">   +0x1934 DpcRequestSummary : Int4B</span><br><span class="line">   +0x1934 DpcRequestSlot   : [2] Int2B</span><br><span class="line">   +0x1934 NormalDpcState   : Int2B</span><br><span class="line">   +0x1936 DpcThreadActive  : Pos 0, 1 Bit</span><br><span class="line">   +0x1936 ThreadDpcState   : Int2B</span><br><span class="line">   +0x1938 TimerHand        : Uint4B</span><br><span class="line">   +0x193c LastTick         : Uint4B</span><br><span class="line">   +0x1940 MasterOffset     : Int4B</span><br><span class="line">   +0x1944 PrcbPad41        : [2] Uint4B</span><br><span class="line">   +0x194c PeriodicCount    : Uint4B</span><br><span class="line">   +0x1950 PeriodicBias     : Uint4B</span><br><span class="line">   +0x1958 TickOffset       : Uint8B</span><br><span class="line">   +0x1960 TimerTable       : _KTIMER_TABLE</span><br><span class="line">   +0x31a0 CallDpc          : _KDPC</span><br><span class="line">   +0x31c0 ClockKeepAlive   : Int4B</span><br><span class="line">   +0x31c4 ClockCheckSlot   : UChar</span><br><span class="line">   +0x31c5 ClockPollCycle   : UChar</span><br><span class="line">   +0x31c6 PrcbPad6         : [2] UChar</span><br><span class="line">   +0x31c8 DpcWatchdogPeriod : Int4B</span><br><span class="line">   +0x31cc DpcWatchdogCount : Int4B</span><br><span class="line">   +0x31d0 ThreadWatchdogPeriod : Int4B</span><br><span class="line">   +0x31d4 ThreadWatchdogCount : Int4B</span><br><span class="line">   +0x31d8 KeSpinLockOrdering : Int4B</span><br><span class="line">   +0x31dc PrcbPad70        : [1] Uint4B</span><br><span class="line">   +0x31e0 WaitListHead     : _LIST_ENTRY</span><br><span class="line">   +0x31e8 WaitLock         : Uint4B</span><br><span class="line">   +0x31ec ReadySummary     : Uint4B</span><br><span class="line">   +0x31f0 QueueIndex       : Uint4B</span><br><span class="line">   +0x31f4 DeferredReadyListHead : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x31f8 StartCycles      : Uint8B</span><br><span class="line">   +0x3200 CycleTime        : Uint8B</span><br><span class="line">   +0x3208 HighCycleTime    : Uint4B</span><br><span class="line">   +0x320c PrcbPad71        : Uint4B</span><br><span class="line">   +0x3210 PrcbPad72        : [2] Uint8B</span><br><span class="line">   +0x3220 DispatcherReadyListHead : [32] _LIST_ENTRY</span><br><span class="line">   +0x3320 ChainedInterruptList : Ptr32 Void</span><br><span class="line">   +0x3324 LookasideIrpFloat : Int4B</span><br><span class="line">   +0x3328 MmPageFaultCount : Int4B</span><br><span class="line">   +0x332c MmCopyOnWriteCount : Int4B</span><br><span class="line">   +0x3330 MmTransitionCount : Int4B</span><br><span class="line">   +0x3334 MmCacheTransitionCount : Int4B</span><br><span class="line">   +0x3338 MmDemandZeroCount : Int4B</span><br><span class="line">   +0x333c MmPageReadCount  : Int4B</span><br><span class="line">   +0x3340 MmPageReadIoCount : Int4B</span><br><span class="line">   +0x3344 MmCacheReadCount : Int4B</span><br><span class="line">   +0x3348 MmCacheIoCount   : Int4B</span><br><span class="line">   +0x334c MmDirtyPagesWriteCount : Int4B</span><br><span class="line">   +0x3350 MmDirtyWriteIoCount : Int4B</span><br><span class="line">   +0x3354 MmMappedPagesWriteCount : Int4B</span><br><span class="line">   +0x3358 MmMappedWriteIoCount : Int4B</span><br><span class="line">   +0x335c CachedCommit     : Uint4B</span><br><span class="line">   +0x3360 CachedResidentAvailable : Uint4B</span><br><span class="line">   +0x3364 HyperPte         : Ptr32 Void</span><br><span class="line">   +0x3368 PrcbPad8         : [4] UChar</span><br><span class="line">   +0x336c VendorString     : [13] UChar</span><br><span class="line">   +0x3379 InitialApicId    : UChar</span><br><span class="line">   +0x337a LogicalProcessorsPerPhysicalProcessor : UChar</span><br><span class="line">   +0x337b PrcbPad9         : [5] UChar</span><br><span class="line">   +0x3380 FeatureBits      : Uint4B</span><br><span class="line">   +0x3388 UpdateSignature  : _LARGE_INTEGER</span><br><span class="line">   +0x3390 IsrTime          : Uint8B</span><br><span class="line">   +0x3398 RuntimeAccumulation : Uint8B</span><br><span class="line">   +0x33a0 PowerState       : _PROCESSOR_POWER_STATE</span><br><span class="line">   +0x3468 DpcWatchdogDpc   : _KDPC</span><br><span class="line">   +0x3488 DpcWatchdogTimer : _KTIMER</span><br><span class="line">   +0x34b0 WheaInfo         : Ptr32 Void</span><br><span class="line">   +0x34b4 EtwSupport       : Ptr32 Void</span><br><span class="line">   +0x34b8 InterruptObjectPool : _SLIST_HEADER</span><br><span class="line">   +0x34c0 HypercallPageList : _SLIST_HEADER</span><br><span class="line">   +0x34c8 HypercallPageVirtual : Ptr32 Void</span><br><span class="line">   +0x34cc VirtualApicAssist : Ptr32 Void</span><br><span class="line">   +0x34d0 StatisticsPage   : Ptr32 Uint8B</span><br><span class="line">   +0x34d4 RateControl      : Ptr32 Void</span><br><span class="line">   +0x34d8 Cache            : [5] _CACHE_DESCRIPTOR</span><br><span class="line">   +0x3514 CacheCount       : Uint4B</span><br><span class="line">   +0x3518 CacheProcessorMask : [5] Uint4B</span><br><span class="line">   +0x352c PackageProcessorSet : _KAFFINITY_EX</span><br><span class="line">   +0x3538 PrcbPad91        : [1] Uint4B</span><br><span class="line">   +0x353c CoreProcessorSet : Uint4B</span><br><span class="line">   +0x3540 TimerExpirationDpc : _KDPC</span><br><span class="line">   +0x3560 SpinLockAcquireCount : Uint4B</span><br><span class="line">   +0x3564 SpinLockContentionCount : Uint4B</span><br><span class="line">   +0x3568 SpinLockSpinCount : Uint4B</span><br><span class="line">   +0x356c IpiSendRequestBroadcastCount : Uint4B</span><br><span class="line">   +0x3570 IpiSendRequestRoutineCount : Uint4B</span><br><span class="line">   +0x3574 IpiSendSoftwareInterruptCount : Uint4B</span><br><span class="line">   +0x3578 ExInitializeResourceCount : Uint4B</span><br><span class="line">   +0x357c ExReInitializeResourceCount : Uint4B</span><br><span class="line">   +0x3580 ExDeleteResourceCount : Uint4B</span><br><span class="line">   +0x3584 ExecutiveResourceAcquiresCount : Uint4B</span><br><span class="line">   +0x3588 ExecutiveResourceContentionsCount : Uint4B</span><br><span class="line">   +0x358c ExecutiveResourceReleaseExclusiveCount : Uint4B</span><br><span class="line">   +0x3590 ExecutiveResourceReleaseSharedCount : Uint4B</span><br><span class="line">   +0x3594 ExecutiveResourceConvertsCount : Uint4B</span><br><span class="line">   +0x3598 ExAcqResExclusiveAttempts : Uint4B</span><br><span class="line">   +0x359c ExAcqResExclusiveAcquiresExclusive : Uint4B</span><br><span class="line">   +0x35a0 ExAcqResExclusiveAcquiresExclusiveRecursive : Uint4B</span><br><span class="line">   +0x35a4 ExAcqResExclusiveWaits : Uint4B</span><br><span class="line">   +0x35a8 ExAcqResExclusiveNotAcquires : Uint4B</span><br><span class="line">   +0x35ac ExAcqResSharedAttempts : Uint4B</span><br><span class="line">   +0x35b0 ExAcqResSharedAcquiresExclusive : Uint4B</span><br><span class="line">   +0x35b4 ExAcqResSharedAcquiresShared : Uint4B</span><br><span class="line">   +0x35b8 ExAcqResSharedAcquiresSharedRecursive : Uint4B</span><br><span class="line">   +0x35bc ExAcqResSharedWaits : Uint4B</span><br><span class="line">   +0x35c0 ExAcqResSharedNotAcquires : Uint4B</span><br><span class="line">   +0x35c4 ExAcqResSharedStarveExclusiveAttempts : Uint4B</span><br><span class="line">   +0x35c8 ExAcqResSharedStarveExclusiveAcquiresExclusive : Uint4B</span><br><span class="line">   +0x35cc ExAcqResSharedStarveExclusiveAcquiresShared : Uint4B</span><br><span class="line">   +0x35d0 ExAcqResSharedStarveExclusiveAcquiresSharedRecursive : Uint4B</span><br><span class="line">   +0x35d4 ExAcqResSharedStarveExclusiveWaits : Uint4B</span><br><span class="line">   +0x35d8 ExAcqResSharedStarveExclusiveNotAcquires : Uint4B</span><br><span class="line">   +0x35dc ExAcqResSharedWaitForExclusiveAttempts : Uint4B</span><br><span class="line">   +0x35e0 ExAcqResSharedWaitForExclusiveAcquiresExclusive : Uint4B</span><br><span class="line">   +0x35e4 ExAcqResSharedWaitForExclusiveAcquiresShared : Uint4B</span><br><span class="line">   +0x35e8 ExAcqResSharedWaitForExclusiveAcquiresSharedRecursive : Uint4B</span><br><span class="line">   +0x35ec ExAcqResSharedWaitForExclusiveWaits : Uint4B</span><br><span class="line">   +0x35f0 ExAcqResSharedWaitForExclusiveNotAcquires : Uint4B</span><br><span class="line">   +0x35f4 ExSetResOwnerPointerExclusive : Uint4B</span><br><span class="line">   +0x35f8 ExSetResOwnerPointerSharedNew : Uint4B</span><br><span class="line">   +0x35fc ExSetResOwnerPointerSharedOld : Uint4B</span><br><span class="line">   +0x3600 ExTryToAcqExclusiveAttempts : Uint4B</span><br><span class="line">   +0x3604 ExTryToAcqExclusiveAcquires : Uint4B</span><br><span class="line">   +0x3608 ExBoostExclusiveOwner : Uint4B</span><br><span class="line">   +0x360c ExBoostSharedOwners : Uint4B</span><br><span class="line">   +0x3610 ExEtwSynchTrackingNotificationsCount : Uint4B</span><br><span class="line">   +0x3614 ExEtwSynchTrackingNotificationsAccountedCount : Uint4B</span><br><span class="line">   +0x3618 Context          : Ptr32 _CONTEXT</span><br><span class="line">   +0x361c ContextFlags     : Uint4B</span><br><span class="line">   +0x3620 ExtendedState    : Ptr32 _XSAVE_AREA</span><br></pre></td></tr></table></figure>
<p><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/7.png?x-oss-process=style/yangruiqi.com" alt="7"></p>
<p>最后面4个是保护模式下用不的到的，中断门在发生权限切换时候，会向0环的堆栈压入5个值，就是0x068到0x078，快速调用没有。<br>代码中push 0 ，就是0x64，errorcode，</p>
<p>下面是KiSystemServer的反汇编加注释，用到了上面的结构体：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">.text:0043567E _KiSystemService proc near              ; CODE XREF: ZwAcceptConnectPort(x,x,x,x,x,x)+Cp</span><br><span class="line">.text:0043567E                                         ; ZwAccessCheck(x,x,x,x,x,x,x,x)+Cp ...</span><br><span class="line">.text:0043567E</span><br><span class="line">.text:0043567E arg_0           = dword ptr  4</span><br><span class="line">.text:0043567E</span><br><span class="line">.text:0043567E                 push    0               ; _KTRAP_FRAME +0x064 ErrCode</span><br><span class="line">.text:00435680                 push    ebp             ; 0x060 Ebp,3环寄存器入栈</span><br><span class="line">.text:00435681                 push    ebx             ; 0x05C,ebx</span><br><span class="line">.text:00435682                 push    esi             ; 0x058 Esi</span><br><span class="line">.text:00435683                 push    edi             ; 0x054 Edi</span><br><span class="line">.text:00435684                 push    fs              ; 0x050 SegFs</span><br><span class="line">.text:00435686                 mov     ebx, 30h        ; 为FS寄存器赋值,30就是段选择子，在GDTR找到相应的段描述符，加载到，FS，指向KPCR结构体</span><br><span class="line">.text:0043568B                 mov     fs, bx          ; Windows内核有个特殊的基本要求，就是只要CPU在内核运行，就得使</span><br><span class="line">.text:0043568B                                         ; mov ebx,30 //0011 0000  所以就是0环GDT索引6</span><br><span class="line">.text:0043568B                                         ; mov fs,bx</span><br><span class="line">.text:0043568B                                         ;</span><br><span class="line">.text:0043568B                                         ; 0环的FS.Base指向CPU自己的KPCR，不是指向当前线程</span><br><span class="line">.text:0043568B                                         ; 选择码，0x30的结构分析如下：</span><br><span class="line">.text:0043568B                                         ; 1.bit0~bit1:RPL,Requested Privilege Level,要求运行的级别，这里是0</span><br><span class="line">.text:0043568B                                         ; 2.bit2：找GDT还是IDT，这里是0，GDT</span><br><span class="line">.text:0043568B                                         ; 3.bit3！bit15，是在GDT或者IDT的下标</span><br><span class="line">.text:0043568B                                         ; windbg查看段描述符：834093f2 dc003748</span><br><span class="line">.text:0043568B                                         ; Base:83f2dc00 指向当前的_KPCR</span><br><span class="line">.text:0043568E                 mov     ebx, 23h</span><br><span class="line">.text:00435693                 mov     ds, ebx</span><br><span class="line">.text:00435695                 mov     es, ebx</span><br><span class="line">.text:00435697                 mov     esi, large fs:124h ; 查看下KPCR偏移124h是什么，查训发现是当前CPU所执行线程的_ETHREAD</span><br><span class="line">.text:0043569E                 push    large dword ptr fs:0 ; 保存老的ExceptionList</span><br><span class="line">.text:0043569E                                         ; _KPCR偏移+0x00-&gt;NT_TIB-&gt;ExceptionList</span><br><span class="line">.text:004356A5                 mov     large dword ptr fs:0, 0FFFFFFFFh ; 新的ExceptonList为空白，因为3环的异常链表，不能用，要进0环了</span><br><span class="line">.text:004356B0                 push    dword ptr [esi+13Ah] ; 因为Esi存的_KTHREAD,他的偏移13A存的PreviousMode,</span><br><span class="line">.text:004356B0                                         ; 就是保存老的先前模式到堆栈</span><br><span class="line">.text:004356B0                                         ; 先前模式就是当调用这些代码时候，原来是几环的数就是几，比如原来0环，先前模式就是0，原来3环就是1</span><br><span class="line">.text:004356B0                                         ; 因为有些内核代码可以从0和3调用，但是执行内容不一样，通过这个知道执行什么。</span><br><span class="line">.text:004356B6                 sub     esp, 48h        ; ESP 提升到_KTRAP_FRAME结构体第一个成员，也就是这个结构体指针</span><br><span class="line">.text:004356B9                 mov     ebx, [esp+68h+arg_0] ; 查了下这个位置是3环CS</span><br><span class="line">.text:004356B9                                         ; 所以这句是取出3环压入的参数CS _KTRAP_FRAME + 0x6C</span><br><span class="line">.text:004356BD                 and     ebx, 1          ; 上面的CS跟1与运算</span><br><span class="line">.text:004356BD                                         ; 0环最低位是0,3环最低位为1</span><br><span class="line">.text:004356C0                 mov     [esi+13Ah], bl  ; 上面的运算结果存到esi+0x13Ah这个位置的偏移，就是新的&quot;先前模式&quot;</span><br><span class="line">.text:004356C6                 mov     ebp, esp        ; 抬高栈针,ebp=esp=_KTRAP_FRAME指针</span><br><span class="line">.text:004356C8                 mov     ebx, [esi+128h] ; _KTHTEAD中的TrapFrame给ebx</span><br><span class="line">.text:004356CE                 mov     [ebp+3Ch], ebx  ; 将_KTHREAD中的Trap_Frame暂时存在这个位置后面</span><br><span class="line">.text:004356CE                                         ; //会将这个值取出来，重新恢复给_KTHREAD的Trap_Frame</span><br><span class="line">.text:004356CE                                         ;</span><br><span class="line">.text:004356CE                                         ; 零时存在这</span><br><span class="line">.text:004356D1                 and     dword ptr [ebp+2Ch], 0 ; Dr7清0</span><br><span class="line">.text:004356D5                 test    byte ptr [esi+3], 0DFh ; 查看当前线程是否处于调试状态</span><br><span class="line">.text:004356D5                                         ; 看看是不是-1，</span><br><span class="line">.text:004356D9                 mov     [esi+128h], ebp ; 因为有改变堆栈中的_KTRAP_FRAME,将其重新赋值给_KTHREAD中的TRAPFRAME</span><br><span class="line">.text:004356DF                 cld</span><br><span class="line">.text:004356E0                 jnz     Dr_kss_a        ; 处于调试的话跳转,跳转那边的代码是讲调试寄存器都存到Trap_Frame里</span><br><span class="line">.text:004356E6</span><br><span class="line">.text:004356E6 loc_4356E6:                             ; CODE XREF: Dr_kss_a+Dj</span><br><span class="line">.text:004356E6                                         ; Dr_kss_a+79j</span><br><span class="line">.text:004356E6                 mov     ebx, [ebp+60h]  ; 3环的Ebx给ebx</span><br><span class="line">.text:004356E9                 mov     edi, [ebp+68h]  ; 3环的Eip</span><br><span class="line">.text:004356EC                 mov     [ebp+0Ch], edx  ; edx存的3环参数指针：</span><br><span class="line">.text:004356EC                                         ;</span><br><span class="line">.text:004356EC                                         ; _kiFastSystemCall函数</span><br><span class="line">.text:004356EC                                         ;</span><br><span class="line">.text:004356EC                                         ; mov edx，esp</span><br><span class="line">.text:004356EC                                         ;</span><br><span class="line">.text:004356EC                                         ; sysenter</span><br><span class="line">.text:004356EF                 mov     dword ptr [ebp+8], 0BADB0D00h ; 这个是操作系统的标志</span><br><span class="line">.text:004356F6                 mov     [ebp+0], ebx    ; 3环的ebp存储到KTRAP_FRAME+0x000 DbgEbp的位置</span><br><span class="line">.text:004356F9                 mov     [ebp+4], edi    ; 3环的ebp存储到KTRAP_FRAME+0x004 DbgEip的位置</span><br><span class="line">.text:004356FC                 sti</span><br><span class="line">.text:004356FD                 jmp     loc_4357DF      ; 跳到KiFastCallEntry</span><br><span class="line">.text:004356FD _KiSystemService endp</span><br></pre></td></tr></table></figure>
<p>最后还是跳到了KiFastCallEntry，最后发现从两个口进来最后都要执行一样的代码</p>
<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><p>[1]：毛德操，《Windows内核情景分析》<br>[2]：滴水视频<br>[3]: 一大堆的别人的博客  </p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">yangruiqi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/06/30/系统调用笔记上/">http://yoursite.com/2018/06/30/系统调用笔记上/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">manyouyou</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/系统调用/">系统调用</a><a class="post-meta__tags" href="/tags/驱动学习/">驱动学习</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/收款码/zhifubao.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/收款码/weixin.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/06/30/系统调用笔记下/"><i class="fa fa-chevron-left">  </i><span>系统调用笔记下</span></a></div><div class="next-post pull-right"><a href="/2018/06/28/object-Hook相关知识/"><span>object_Hook相关知识</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  owner: 'yangruiqiyr',
  repo: 'BlogGitment',
  oauth: {
    client_id: 'dfbfacd2fb59427cee9e',
    client_secret: 'a39b872c7d6ddf551a16ebf9a3d59ce9b57508bb'
  }
})
gitment.render('gitment-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2018 By yangruiqi</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="www.yangruiqiyr.com">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.5"></script><script src="/js/fancybox.js?version=1.5.5"></script><script src="/js/sidebar.js?version=1.5.5"></script><script src="/js/copy.js?version=1.5.5"></script><script src="/js/fireworks.js?version=1.5.5"></script><script src="/js/transition.js?version=1.5.5"></script><script src="/js/scroll.js?version=1.5.5"></script><script src="/js/head.js?version=1.5.5"></script></body></html>